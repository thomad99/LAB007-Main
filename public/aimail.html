<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB007 AIMAIL</title>
    <link rel="icon" type="image/png" href="/images/lab007 Icon.PNG">
    <link rel="shortcut icon" type="image/png" href="/images/lab007 Icon.PNG">
    <link rel="apple-touch-icon" href="/images/lab007 Icon.PNG">
    <style>
        :root {
            --primary: #0a66c2;
            --accent: #d4af37;
            --bg: #f5f7fb;
            --card: #ffffff;
            --muted: #5a6270;
            --border: #d8deea;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--bg);
            color: #1f2933;
        }
        header {
            background: var(--card);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        header img { width: 40px; height: 40px; object-fit: contain; }
        header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 0.02em; }
        main { max-width: 1200px; margin: 12px auto 36px; padding: 0 12px; display: grid; grid-template-columns: 280px 1fr; gap: 10px; }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            padding: 12px;
        }
        .section-title { margin: 0 0 10px; font-size: 1rem; color: var(--muted); }
        .input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #fbfcff;
            font: inherit;
        }
        textarea { min-height: 96px; }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.08s ease, box-shadow 0.12s ease;
        }
        .btn.secondary { background: #e5e7eb; color: #111; }
        .btn:hover { box-shadow: 0 6px 18px rgba(10,102,194,0.25); }
        .btn:active { transform: translateY(1px); }
        .list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .sender-item {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            cursor: pointer;
            transition: border 0.1s ease, box-shadow 0.1s ease;
        }
        .sender-item:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
        .sender-meta { display: flex; align-items: center; gap: 10px; }
        .logo {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
        }
        .badge { padding: 2px 8px; border-radius: 999px; font-size: 0.8rem; }
        .badge.junk { background: #fee2e2; color: #991b1b; }
        .badge.ok { background: #e0f2fe; color: #075985; }
        .star { color: #f59e0b; font-size: 1.1rem; }
        .channels-wrap { max-height: calc(100vh - 190px); overflow-y: auto; padding-right: 4px; }
        .thread-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .thread-title-row { display: flex; align-items: center; gap: 8px; flex: 1 1 260px; min-width: 240px; }
        .thread-title-row input {
            font-size: 1.05rem;
            font-weight: 700;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 8px;
            min-width: 180px;
            flex: 1;
        }
        .thread-action-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        .thread-action-badges .btn { min-height: 34px; }
        .thread-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .thread-body { display: flex; flex-direction: column; gap: 10px; }
        .bubble {
            position: relative;
            padding: 12px 14px;
            border-radius: 16px;
            max-width: 75%;
            box-shadow: 0 6px 14px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
            background: linear-gradient(135deg, #f9fbff 0%, #eef2ff 100%);
        }
        .bubble.them { margin-right: auto; background: linear-gradient(135deg, #f9fbff 0%, #eef2ff 100%); border-color: #cfd8ff; }
        .bubble.me { margin-left: auto; background: linear-gradient(135deg, #e1ffe5 0%, #c0f7cc 100%); border-color: #9be6ae; }
        .bubble .meta {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .bubble .actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 6px;
        }
        .favorite { color: #f59e0b; cursor: pointer; }
        .search-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: #fff; cursor: pointer; }
        .pill.active { border-color: var(--primary); color: var(--primary); }
        .status { color: var(--muted); font-size: 0.9rem; margin-top: 6px; }
        .flex { display: flex; gap: 8px; }
        .mobile-hide { display: none !important; }
        .mobile-back { display: none; }
        @media (max-width: 960px) {
            main { grid-template-columns: 1fr; }
            .thread-title-row { flex: 1 1 100%; }
            .thread-action-badges { width: 100%; }
            .thread-header { gap: 8px; }
            .channels-wrap { max-height: none; }
            .mobile-back { display: inline-flex; }
        }
    </style>
</head>
<body>
    <header>
        <img src="/images/lab007 Icon.PNG" alt="LAB007">
        <div>
            <h1>AIMAIL ‚Äì Inbox Channels</h1>
            <div style="color: var(--muted); font-size: 0.9rem;">Email-to-channel view with junk control, search, and favorites.</div>
        </div>
    </header>

    <main>
        <section class="card" id="channelsCard">
            <h2 class="section-title">Channels</h2>
            <div class="search-row">
                <input id="senderSearch" class="input" placeholder="Search senders..." />
                <button class="btn secondary" id="resetFilters">Reset</button>
                <button class="btn secondary" id="favChannelFilterBtn">Show: All</button>
                <button class="btn secondary" id="channelSortBtn">Sort: Recent</button>
            </div>
            <div class="channels-wrap">
                <ul class="list" id="senderList"></ul>
            </div>
            <div class="status" id="senderStatus"></div>
        </section>

        <section class="card" id="threadCard">
            <div class="thread-header">
                <button class="btn secondary mobile-back" id="backToChannels">‚Üê Back</button>
                <img id="threadLogo" class="logo" src="/images/lab007 Icon.PNG" alt="logo">
                <div style="flex:1; min-width:240px;">
                    <div class="thread-title-row">
                        <input id="threadNameInput" value="Select a sender">
                        <div class="thread-action-badges">
                            <button class="btn secondary" id="junkToggleBtn" title="Mark/Unmark as junk">Junk: No</button>
                            <button class="btn secondary" id="favChannelBtn" title="Favorite this channel">‚òÜ Channel</button>
                            <button class="btn secondary" id="uploadLogoBtn" title="Change logo">Upload logo</button>
                        </div>
                    </div>
                    <div id="threadMeta" class="status">Unread: 0 ¬∑ Total: 0</div>
                </div>
            </div>

            <div class="thread-controls">
                <input id="threadSearch" class="input" placeholder="Search in this thread...">
                <button class="btn secondary" id="sortBtn">Sort: Newest</button>
                <button class="btn secondary" id="favFilterBtn">Show: All</button>
                <button class="btn secondary" id="fullPageBtn" title="Open this thread full screen">Full page</button>
            </div>

            <div class="search-row">
                <input id="llmQuery" class="input" placeholder="LLM smart search (trip to New York...)">
                <button class="btn" id="llmRun">LLM Search</button>
            </div>
            <div class="status" id="llmStatus">LLM search will use your OpenAI key (backend needed).</div>

            <div id="threadEmails"></div>
        </section>
    </main>

    <section class="card" style="max-width:1200px;margin:0 auto 48px;padding:14px;">
        <h2 class="section-title">Admin (branding, junk, search)</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <div class="status" id="adminTotals">Emails: 0 (unread 0)</div>
        </div>
        <div class="flex" style="flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
                <label>Display name</label>
                <input id="adminDisplay" class="input" placeholder="Friendly channel name">
                <label style="margin-top:10px;">Logo URL</label>
                <input id="adminLogo" class="input" placeholder="https://...png">
                <label style="margin-top:10px;">Junk status</label>
                <select id="adminJunk" class="input">
                    <option value="false">Not junk</option>
                    <option value="true">Junk</option>
                </select>
                <button class="btn" id="adminSave">Save channel</button>
            </div>
            <div style="flex:1; min-width:260px;">
                <label>Global text search</label>
                <input id="adminSearch" class="input" placeholder="Search all messages...">
                <label style="margin-top:10px;">LLM search prompt</label>
                <textarea id="adminLLMSearch" placeholder="Ask in natural language..."></textarea>
                <button class="btn secondary" id="adminSearchBtn">Search</button>
            </div>
        </div>
        <div class="status" id="adminStatus">Select a channel above to edit. Read/unread counts update when you view messages (does not alter server unread state).</div>
    </section>

    <script>
        // Simple in-memory demo data; backend wiring required for real mail sync.
        const defaultLogo = '/images/lab007 Icon.PNG';
        const data = { senders: [] };

        let currentSender = null;
        let sortNewest = true;
        let favOnly = false;
        let showFavChannelsOnly = false;
        let channelSortMode = 'recent'; // 'recent' or 'alpha'
        let mobileMode = window.innerWidth <= 960;
        let showingChannel = false;

        const senderList = document.getElementById('senderList');
        const senderSearch = document.getElementById('senderSearch');
        const senderStatus = document.getElementById('senderStatus');
        const threadNameInput = document.getElementById('threadNameInput');
        const threadMeta = document.getElementById('threadMeta');
        const threadLogo = document.getElementById('threadLogo');
        const threadEmails = document.getElementById('threadEmails');
        const threadSearch = document.getElementById('threadSearch');
        const sortBtn = document.getElementById('sortBtn');
        const favFilterBtn = document.getElementById('favFilterBtn');
        const fullPageBtn = document.getElementById('fullPageBtn');
        const llmRun = document.getElementById('llmRun');
        const llmQuery = document.getElementById('llmQuery');
        const llmStatus = document.getElementById('llmStatus');
        const adminDisplay = document.getElementById('adminDisplay');
        const adminLogo = document.getElementById('adminLogo');
        const adminJunk = document.getElementById('adminJunk');
        const adminSave = document.getElementById('adminSave');
        const adminSearch = document.getElementById('adminSearch');
        const adminLLMSearch = document.getElementById('adminLLMSearch');
        const adminSearchBtn = document.getElementById('adminSearchBtn');
        const adminStatus = document.getElementById('adminStatus');
        const resetFilters = document.getElementById('resetFilters');
        const adminTotals = document.getElementById('adminTotals');
        const favChannelFilterBtn = document.getElementById('favChannelFilterBtn');
        const favChannelBtn = document.getElementById('favChannelBtn');
        const channelSortBtn = document.getElementById('channelSortBtn');
        const junkToggleBtn = document.getElementById('junkToggleBtn');
        const uploadLogoBtn = document.getElementById('uploadLogoBtn');
        const channelsCard = document.getElementById('channelsCard');
        const threadCard = document.getElementById('threadCard');
        const backToChannels = document.getElementById('backToChannels');

        async function loadChannels() {
            try {
                senderStatus.textContent = 'Loading channels...';
                const res = await fetch('/api/aimail/channels/refresh');
                const json = await res.json();
                data.senders = json.channels || [];
                renderSenders();
                senderStatus.textContent = `${data.senders.length} channel(s) loaded.`;
            } catch (err) {
                senderStatus.textContent = 'Failed to load channels: ' + err.message;
            }
        }

        async function loadChannel(id, forceFetch = false) {
            try {
                const res = await fetch(`/api/aimail/channel/${encodeURIComponent(id)}${forceFetch ? '/fetch' : ''}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                const existing = data.senders.find(s => s.id === id);
                if (existing) {
                    existing.emails = json.emails || [];
                    existing.display = json.display;
                    existing.domain = json.domain;
                    existing.logo = json.logo;
                    existing.junk = json.junk;
                    existing.favorite = json.favorite;
                    existing.lastDate = json.lastDate || (existing.emails.length ? Math.max(...existing.emails.map(e => new Date(e.date || 0).getTime())) : null);
                    existing.total = json.total || existing.emails.length;
                }
                renderEmails();
                updateTotals();
            } catch (err) {
                threadEmails.innerHTML = `<div class="status">Failed to load thread: ${err.message}</div>`;
            }
        }

        function updateTotals() {
            let total = 0, unread = 0;
            data.senders.forEach(s => {
                total += (s.emails || []).length;
                unread += (s.emails || []).filter(e => e.unread).length;
            });
            adminTotals.textContent = `Emails: ${total} (unread ${unread})`;
        }

        function renderSenders() {
            const q = senderSearch.value.toLowerCase();
            senderList.innerHTML = '';
            [...data.senders]
                .sort((a, b) => {
                    if (channelSortMode === 'alpha') {
                        const an = (a.display || a.id || '').toLowerCase();
                        const bn = (b.display || b.id || '').toLowerCase();
                        return an.localeCompare(bn);
                    }
                    const da = a.lastDate || 0;
                    const db = b.lastDate || 0;
                    return db - da;
                })
                .filter(s => (!showFavChannelsOnly || s.favorite) && (!q || s.id.toLowerCase().includes(q) || (s.display || '').toLowerCase().includes(q) || (s.domain || '').toLowerCase().includes(q)))
                .forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'sender-item';
                    li.onclick = () => selectSender(s.id);
                    const unread = (s.emails || []).filter(e => e.unread).length;
                    const total = (s.emails || []).length;
                    li.innerHTML = `
                        <div class="sender-meta">
                            <img class="logo" src="${s.logo || defaultLogo}" alt="">
                            <div>
                                <div style="font-weight:700;">${s.display || s.domain || s.id}</div>
                                <div style="color:var(--muted);font-size:0.9rem;">${s.id}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div class="star">${s.favorite ? '‚òÖ' : '‚òÜ'}</div>
                            <div class="badge ${s.junk ? 'junk' : 'ok'}">${s.junk ? 'Junk' : 'OK'}</div>
                            <div style="font-size:0.85rem;color:var(--muted);">Unread: ${unread}</div>
                            <div style="font-size:0.85rem;color:var(--muted);">Total: ${total}</div>
                        </div>
                    `;
                    senderList.appendChild(li);
                });
            senderStatus.textContent = `${data.senders.length} channel(s) loaded.`;
            updateTotals();
        }

        function selectSender(id) {
            currentSender = data.senders.find(s => s.id === id);
            if (!currentSender) return;
            if (!currentSender.emails) currentSender.emails = [];
            threadNameInput.value = currentSender.display || currentSender.domain || currentSender.id;
            const unread = (currentSender.emails || []).filter(e => e.unread).length;
            threadMeta.textContent = `Unread: ${unread} ¬∑ Total: ${currentSender.emails.length} ¬∑ Junk: ${currentSender.junk ? 'Yes' : 'No'}`;
            threadLogo.src = currentSender.logo || defaultLogo;
            adminDisplay.value = currentSender.display || '';
            adminLogo.value = currentSender.logo || '';
            adminJunk.value = currentSender.junk ? 'true' : 'false';
            junkToggleBtn.textContent = `Junk: ${currentSender.junk ? 'Yes' : 'No'}`;
            favChannelBtn.textContent = currentSender.favorite ? '‚òÖ Channel' : '‚òÜ Channel';
            renderEmails();
            loadChannel(id, true);
            if (mobileMode) {
                showingChannel = true;
                applyMobileLayout();
            }
        }

        function renderEmails() {
            if (!currentSender) {
                threadEmails.innerHTML = '<div class="status">Select a sender to view messages.</div>';
                return;
            }
            const renderBody = (text) => {
                if (!text) return '(empty)';
                const esc = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                return esc.replace(/\r?\n/g, '<br>');
            };
            const q = threadSearch.value.toLowerCase();
            let list = [...(currentSender.emails || [])];
            if (favOnly) list = list.filter(e => e.favorite);
            if (q) list = list.filter(e => (e.subject + e.body).toLowerCase().includes(q));
            list.sort((a,b) => sortNewest ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date));
            threadEmails.innerHTML = '';
            threadEmails.className = 'thread-body';
            list.forEach(e => {
                const div = document.createElement('div');
                div.className = `bubble ${e.isMine ? 'me' : 'them'}`;
                div.innerHTML = `
                    <div class="meta">${e.subject || '(no subject)'} ‚Äî ${e.date} ‚Äî ${e.unread ? 'Unread' : 'Read'}</div>
                    <div class="actions">
                        <span class="favorite" title="Favorite">${e.favorite ? '‚òÖ' : '‚òÜ'}</span>
                        <span style="cursor:pointer;color:#b91c1c;" title="Delete">üóë</span>
                    </div>
                    <div>${renderBody(e.body)}</div>
                `;
                const [fav, del] = div.querySelectorAll('.actions span');
                fav.onclick = (ev) => { ev.stopPropagation(); e.favorite = !e.favorite; renderEmails(); };
                del.onclick = async (ev) => {
                    ev.stopPropagation();
                    currentSender.emails = currentSender.emails.filter(x => x.id !== e.id);
                    renderEmails();
                    try {
                        await fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/delete/${encodeURIComponent(e.id)}`, { method: 'POST' });
                    } catch {}
                };
                div.onclick = () => {
                    if (e.unread) { e.unread = false; selectSender(currentSender.id); }
                };
                threadEmails.appendChild(div);
            });
            if (list.length === 0) threadEmails.innerHTML = '<div class="status">No messages match these filters.</div>';
            updateTotals();
        }

        // Admin actions
        adminSave.onclick = () => {
            if (!currentSender) { adminStatus.textContent = 'Select a channel first.'; return; }
            currentSender.display = adminDisplay.value || `e-${currentSender.domain}`;
            currentSender.logo = adminLogo.value || defaultLogo;
            currentSender.junk = adminJunk.value === 'true';
            adminStatus.textContent = 'Saved (in-memory demo). Wire backend to persist.';
            renderSenders();
            selectSender(currentSender.id);
            fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    display: currentSender.display,
                    logo: currentSender.logo,
                    junk: currentSender.junk
                })
            }).catch(() => {});
        };

        adminSearchBtn.onclick = () => {
            const q = adminSearch.value.toLowerCase();
            let count = 0;
            data.senders.forEach(s => s.emails.forEach(e => { if ((e.subject + e.body).toLowerCase().includes(q)) count++; }));
            adminStatus.textContent = `Text search matches: ${count} message(s). LLM search pending backend.`;
        };

        llmRun.onclick = () => {
            const q = llmQuery.value.trim();
            if (!q) { llmStatus.textContent = 'Enter a query first.'; return; }
            if (!currentSender) { llmStatus.textContent = 'Select a sender first.'; return; }
            llmStatus.textContent = 'Running LLM search...';
            fetch('/api/aimail/llm-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: q, senderId: currentSender.id })
            })
            .then(r => r.json())
            .then(json => {
                if (json.ok) {
                    llmStatus.textContent = `LLM result (used ${json.used || 0} msgs): ${json.answer}`;
                } else {
                    llmStatus.textContent = `LLM failed: ${json.error || 'unknown error'}`;
                }
            })
            .catch(err => {
                llmStatus.textContent = 'LLM failed: ' + err.message;
            });
        };

        // Filters
        threadSearch.oninput = renderEmails;
        senderSearch.oninput = renderSenders;
        sortBtn.onclick = () => { sortNewest = !sortNewest; sortBtn.textContent = `Sort: ${sortNewest ? 'Newest' : 'Oldest'}`; renderEmails(); };
        favFilterBtn.onclick = () => { favOnly = !favOnly; favFilterBtn.textContent = `Show: ${favOnly ? 'Favorites' : 'All'}`; renderEmails(); };
        resetFilters.onclick = () => { senderSearch.value=''; renderSenders(); };
        favChannelFilterBtn.onclick = () => { showFavChannelsOnly = !showFavChannelsOnly; favChannelFilterBtn.textContent = `Show: ${showFavChannelsOnly ? 'Favorites' : 'All'}`; renderSenders(); };
        channelSortBtn.onclick = () => {
            channelSortMode = channelSortMode === 'recent' ? 'alpha' : 'recent';
            channelSortBtn.textContent = `Sort: ${channelSortMode === 'recent' ? 'Recent' : 'A-Z'}`;
            renderSenders();
        };
        fullPageBtn.onclick = () => {
            if (!currentSender) {
                alert('Select a sender first.');
                return;
            }
            window.open(`/aimail-thread.html?sender=${encodeURIComponent(currentSender.id)}`, '_blank');
        };
        favChannelBtn.onclick = () => {
            if (!currentSender) { alert('Select a sender first.'); return; }
            currentSender.favorite = !currentSender.favorite;
            favChannelBtn.textContent = currentSender.favorite ? '‚òÖ Channel' : '‚òÜ Channel';
            fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ favorite: currentSender.favorite })
            }).catch(() => {});
            renderSenders();
        };

        junkToggleBtn.onclick = () => {
            if (!currentSender) { alert('Select a sender first.'); return; }
            currentSender.junk = !currentSender.junk;
            junkToggleBtn.textContent = `Junk: ${currentSender.junk ? 'Yes' : 'No'}`;
            adminJunk.value = currentSender.junk ? 'true' : 'false';
            fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ junk: currentSender.junk })
            }).catch(() => {});
            renderSenders();
        };

        threadNameInput.addEventListener('change', () => {
            if (!currentSender) return;
            currentSender.display = threadNameInput.value || currentSender.id;
            adminDisplay.value = currentSender.display;
            fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ display: currentSender.display, logo: currentSender.logo, junk: currentSender.junk, favorite: currentSender.favorite })
            }).catch(() => {});
            renderSenders();
        });

        // Logo upload
        const logoInput = document.createElement('input');
        logoInput.type = 'file';
        logoInput.accept = 'image/*';
        logoInput.style.display = 'none';
        document.body.appendChild(logoInput);
        logoInput.addEventListener('change', async (e) => {
            if (!currentSender) { alert('Select a channel first.'); logoInput.value=''; return; }
            const file = e.target.files?.[0];
            if (!file) return;
            const form = new FormData();
            form.append('file', file);
            try {
                const res = await fetch(`/api/aimail/channel/${encodeURIComponent(currentSender.id)}/logo`, {
                    method: 'POST',
                    body: form
                });
                const json = await res.json();
                if (json.ok && json.url) {
                    currentSender.logo = json.url;
                    adminLogo.value = json.url;
                    renderSenders();
                    selectSender(currentSender.id);
                } else {
                    alert('Upload failed: ' + (json.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Upload failed: ' + err.message);
            } finally {
                logoInput.value = '';
            }
        });

        const logoUploadBtn = document.createElement('button');
        logoUploadBtn.className = 'btn secondary';
        logoUploadBtn.type = 'button';
        logoUploadBtn.textContent = 'Upload logo';
        adminLogo.parentElement.appendChild(document.createElement('div')).appendChild(logoUploadBtn);
        logoUploadBtn.style.marginTop = '8px';
        logoUploadBtn.onclick = () => logoInput.click();

        function applyMobileLayout() {
            mobileMode = window.innerWidth <= 960;
            const hideChannels = mobileMode && showingChannel;
            const hideThread = mobileMode && !showingChannel;
            channelsCard.classList.toggle('mobile-hide', hideChannels);
            threadCard.classList.toggle('mobile-hide', hideThread);
            backToChannels.style.display = hideThread ? 'inline-flex' : (mobileMode ? 'inline-flex' : 'none');
            if (!mobileMode) {
                showingChannel = false;
                channelsCard.classList.remove('mobile-hide');
                threadCard.classList.remove('mobile-hide');
                backToChannels.style.display = 'none';
            }
        }

        window.addEventListener('resize', () => {
            applyMobileLayout();
        });

        backToChannels.onclick = () => {
            showingChannel = false;
            applyMobileLayout();
        };

        // Init
        loadChannels();
        updateTotals();
        applyMobileLayout();
    </script>
</body>
</html>
