<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TomoPI | Raspberry Pi Admin</title>
  <link rel="icon" type="image/png" href="/images/lab007 Icon.PNG">
  <style>
    :root {
      --bg: #0f1419;
      --panel: #1a2332;
      --accent: #3b82f6;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --success: #22c55e;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      margin: 0;
      color: var(--accent);
    }
    .header-logo-wrap {
      display: flex;
      align-items: center;
      text-decoration: none;
    }
    .header-logo {
      height: 48px;
      width: auto;
      opacity: 0.95;
      display: block;
    }
    .panel {
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 20px;
      margin-bottom: 20px;
    }
    .panel h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--muted);
    }
    textarea {
      width: 100%;
      min-height: 380px;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      padding: 16px;
      background: #0d1117;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
    }
    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    .status {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
    }
    .status.success { background: rgba(34,197,94,0.2); color: var(--success); }
    .status.error { background: rgba(239,68,68,0.2); color: var(--error); }
    .status.loading { color: var(--muted); }
    .quick-edit {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .quick-edit label {
      font-size: 14px;
      color: var(--muted);
    }
    .quick-edit select {
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      background: #0d1117;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      cursor: pointer;
    }
    .quick-edit select:focus { outline: none; border-color: var(--accent); }
    .upload-zone {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(59,130,246,0.08); }
    .upload-zone input { display: none; }
    .upload-zone p { margin: 0; color: var(--muted); font-size: 14px; }
    .upload-zone .hint { font-size: 12px; margin-top: 8px; opacity: 0.8; }
    .upload-status { margin-top: 12px; font-size: 13px; }
    .upload-status.success { color: var(--success); }
    .upload-status.error { color: var(--error); }
    .ctrl-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .ctrl-item { display: flex; flex-direction: column; gap: 4px; }
    .ctrl-item label { font-size: 12px; color: var(--muted); }
    .ctrl-item input[type="number"] {
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      background: #0d1117;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
    }
    .ctrl-item input:focus { outline: none; border-color: var(--accent); }
    .ctrl-section { margin-bottom: 20px; }
    .ctrl-section h3 { font-size: 0.9rem; margin: 0 0 12px 0; color: var(--accent); }
    .rss-list { margin-top: 8px; }
    .rss-list textarea {
      min-height: 80px;
      font-size: 12px;
    }
    .rss-presets {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 6px 16px;
      max-height: 180px;
      overflow-y: auto;
      padding: 12px;
      background: #0d1117;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .rss-presets label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text);
    }
    .rss-presets input[type="checkbox"] { cursor: pointer; }
    .ctrl-hint { font-size: 12px; color: var(--muted); margin: 8px 0 0 0; }
    .ctrl-item input[type="time"] {
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      background: #0d1117;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
    }
    .ctrl-item input[type="time"]:focus { outline: none; border-color: var(--accent); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="/" class="header-logo-wrap" title="LAB007">
        <img src="/images/lab007-trans.PNG" alt="LAB007" class="header-logo">
      </a>
      <h1>TomoPI</h1>
    </header>

    <div class="panel">
      <h2>Display config (JSON)</h2>

      <div class="ctrl-section">
        <h3>Mode &amp; rotation</h3>
        <div class="quick-edit">
          <label for="modeSelect">Mode:</label>
          <select id="modeSelect">
            <option value="clock_basic">clock_basic</option>
            <option value="slideshow">slideshow</option>
            <option value="nixie_clock">nixie_clock</option>
            <option value="flip_clock">flip_clock</option>
            <option value="analog_clock">analog_clock</option>
            <option value="video_player">video_player</option>
            <option value="web_images">web_images</option>
            <option value="news_feed">news_feed</option>
          </select>
          <label for="rotateSelect">Screen rotation:</label>
          <select id="rotateSelect">
            <option value="left">left</option>
            <option value="right">right</option>
            <option value="none">none</option>
            <option value="180">180</option>
          </select>
        </div>
      </div>

      <div class="ctrl-section">
        <h3>Screen</h3>
        <div class="ctrl-grid">
          <div class="ctrl-item">
            <label for="brightnessSelect">Brightness</label>
            <select id="brightnessSelect">
              <option value="10">10% — Dim (night)</option>
              <option value="25">25%</option>
              <option value="50">50%</option>
              <option value="75">75%</option>
              <option value="80">80%</option>
              <option value="100">100% — Full</option>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="scheduleEnabled">Schedule (ON/OFF times)</label>
            <select id="scheduleEnabled">
              <option value="false">Always on</option>
              <option value="true">Use schedule</option>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="onTimeInput">Screen ON at</label>
            <input type="time" id="onTimeInput" value="07:00">
          </div>
          <div class="ctrl-item">
            <label for="offTimeInput">Screen OFF at</label>
            <input type="time" id="offTimeInput" value="22:00">
          </div>
        </div>
        <p class="ctrl-hint">When schedule is enabled, the display turns on at the ON time and off at the OFF time (e.g. 7:00 AM–10:00 PM).</p>
      </div>

      <div class="ctrl-section" id="colorFontSection">
        <h3>Font &amp; colors</h3>
        <div class="ctrl-grid">
          <div class="ctrl-item">
            <label for="fontColorSelect">Font color</label>
            <select id="fontColorSelect">
              <optgroup label="Plain">
                <option value="255,255,255">White</option>
                <option value="0,0,0">Black</option>
                <option value="128,128,128">Gray</option>
                <option value="255,0,0">Red</option>
                <option value="255,165,0">Orange</option>
                <option value="255,170,90">Amber</option>
                <option value="255,255,0">Yellow</option>
                <option value="0,255,0">Green</option>
                <option value="0,0,255">Blue</option>
                <option value="128,0,128">Purple</option>
              </optgroup>
              <optgroup label="Neon">
                <option value="57,255,20">Neon Green</option>
                <option value="0,255,255">Neon Blue</option>
                <option value="255,0,255">Neon Pink</option>
                <option value="191,255,0">Neon Lime</option>
                <option value="255,128,0">Neon Orange</option>
                <option value="255,51,51">Neon Red</option>
              </optgroup>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="bgColorSelect">Background color</label>
            <select id="bgColorSelect">
              <optgroup label="Plain">
                <option value="0,0,0">Black</option>
                <option value="255,255,255">White</option>
                <option value="128,128,128">Gray</option>
                <option value="0,18,0">Dark green</option>
              </optgroup>
              <optgroup label="Neon">
                <option value="0,0,0">Black</option>
                <option value="10,10,30">Dark blue</option>
              </optgroup>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="fontSelect">Font</label>
            <select id="fontSelect">
              <option value="dejavusans">dejavusans</option>
              <option value="dejavusansmono">dejavusansmono</option>
              <option value="freesans">freesans</option>
              <option value="arial">arial</option>
              <option value="verdana">verdana</option>
              <option value="tahoma">tahoma</option>
              <option value="liberationsans">liberationsans</option>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="fontSizeInput">Font size</label>
            <input type="number" id="fontSizeInput" min="12" max="400" placeholder="e.g. 220">
          </div>
        </div>
      </div>

      <div class="ctrl-section">
        <h3>Refresh intervals (seconds)</h3>
        <div class="ctrl-grid">
          <div class="ctrl-item">
            <label for="refreshSeconds">Global refresh</label>
            <input type="number" id="refreshSeconds" min="1" placeholder="15">
          </div>
          <div class="ctrl-item">
            <label for="secondsPerSlide">Slideshow / Web: sec per slide</label>
            <input type="number" id="secondsPerSlide" min="1" placeholder="6">
          </div>
          <div class="ctrl-item">
            <label for="refreshListSeconds">Web images: refresh list</label>
            <input type="number" id="refreshListSeconds" min="60" placeholder="300">
          </div>
          <div class="ctrl-item">
            <label for="itemSeconds">News: item display time</label>
            <input type="number" id="itemSeconds" min="1" placeholder="10">
          </div>
          <div class="ctrl-item">
            <label for="refreshNewsSeconds">News: refresh RSS</label>
            <input type="number" id="refreshNewsSeconds" min="60" placeholder="600">
          </div>
          <div class="ctrl-item">
            <label for="refreshStocksSeconds">News: refresh stocks</label>
            <input type="number" id="refreshStocksSeconds" min="60" placeholder="240">
          </div>
        </div>
      </div>

      <div class="ctrl-section" id="newsFeedSection">
        <h3>News feed</h3>
        <div class="ctrl-grid">
          <div class="ctrl-item">
            <label for="transitionSelect">Transition</label>
            <select id="transitionSelect">
              <option value="none">none — No animation (instant switch)</option>
              <option value="fade">fade — Crossfade from old → new</option>
              <option value="slide_left">slide_left — Old slides off left, new from right</option>
              <option value="slide_right">slide_right — Old slides off right, new from left</option>
              <option value="drop_down">drop_down — Old drops down, new drops from top</option>
            </select>
          </div>
          <div class="ctrl-item">
            <label for="transitionMs">Transition (ms)</label>
            <input type="number" id="transitionMs" min="100" placeholder="450">
          </div>
          <div class="ctrl-item">
            <label for="maxHeadlines">Max headlines</label>
            <input type="number" id="maxHeadlines" min="1" max="50" placeholder="10">
          </div>
        </div>
        <div class="ctrl-item rss-list">
          <label>RSS feeds — select one or more</label>
          <div class="rss-presets" id="rssPresets"></div>
          <label for="rssFeeds" style="margin-top:10px;display:block;">Custom URLs (one per line)</label>
          <textarea id="rssFeeds" placeholder="Add custom feed URLs here..." rows="2"></textarea>
        </div>
        <div class="ctrl-item rss-list">
          <label for="tickersInput">Stock tickers (one per line or comma-separated)</label>
          <textarea id="tickersInput" placeholder="TSLA&#10;IBRX&#10;AAPL" rows="2"></textarea>
        </div>
      </div>

      <p style="margin: 0 0 12px 0; font-size: 13px; color: var(--muted);">
        Edit the config below. Your Raspberry Pi fetches from <code>/tomopi/config.json</code> every <code>refresh_seconds</code>.
      </p>
      <textarea id="configEditor" spellcheck="false" placeholder="Loading..."></textarea>
      <div class="actions">
        <button class="btn btn-primary" id="saveBtn">Save</button>
        <button class="btn btn-secondary" id="reloadBtn">Reload</button>
        <span class="status" id="status"></span>
      </div>
    </div>

    <div class="panel">
      <h2>Slideshow images</h2>
      <p style="margin: 0 0 12px 0; font-size: 13px; color: var(--muted);">
        Upload photos for the slideshow. Stored at <code>/tomopi/images</code> on the server (not in git).
      </p>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="photoInput" accept="image/jpeg,image/png,image/gif,image/webp" multiple>
        <p>Drop photos here or click to browse</p>
        <p class="hint">JPEG, PNG, GIF, WebP — max 20MB each, up to 20 at once</p>
      </div>
      <div class="upload-status" id="uploadStatus"></div>
    </div>
  </div>

  <script>
    const editor = document.getElementById('configEditor');
    const saveBtn = document.getElementById('saveBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const statusEl = document.getElementById('status');
    const modeSelect = document.getElementById('modeSelect');
    const rotateSelect = document.getElementById('rotateSelect');
    const fontColorSelect = document.getElementById('fontColorSelect');
    const bgColorSelect = document.getElementById('bgColorSelect');
    const fontSelect = document.getElementById('fontSelect');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const refreshSeconds = document.getElementById('refreshSeconds');
    const secondsPerSlide = document.getElementById('secondsPerSlide');
    const refreshListSeconds = document.getElementById('refreshListSeconds');
    const itemSeconds = document.getElementById('itemSeconds');
    const refreshNewsSeconds = document.getElementById('refreshNewsSeconds');
    const refreshStocksSeconds = document.getElementById('refreshStocksSeconds');
    const transitionSelect = document.getElementById('transitionSelect');
    const transitionMs = document.getElementById('transitionMs');
    const maxHeadlines = document.getElementById('maxHeadlines');
    const rssFeeds = document.getElementById('rssFeeds');
    const rssPresets = document.getElementById('rssPresets');
    const tickersInput = document.getElementById('tickersInput');
    const brightnessSelect = document.getElementById('brightnessSelect');
    const scheduleEnabled = document.getElementById('scheduleEnabled');
    const onTimeInput = document.getElementById('onTimeInput');
    const offTimeInput = document.getElementById('offTimeInput');

    const CONFIG_URL = '/tomopi/config.json';
    const RSS_PRESETS_DEFAULT = {
      'BBC News': 'https://feeds.bbci.co.uk/news/rss.xml',
      'CNN': 'https://rss.cnn.com/rss/edition.rss',
      'Sky News': 'https://feeds.skynews.com/feeds/rss/home.xml',
      'Al Jazeera': 'https://www.aljazeera.com/xml/rss/all.xml',
      'Reuters': 'https://www.reuters.com/world/rss',
      'Ars Technica': 'https://feeds.arstechnica.com/arstechnica/index',
      'The Verge': 'https://www.theverge.com/rss/index.xml',
      'TechCrunch': 'https://techcrunch.com/feed/',
      'Wired': 'https://www.wired.com/feed/rss',
      'Engadget': 'https://www.engadget.com/rss.xml',
      'Financial Times': 'https://www.ft.com/?format=rss',
      'WSJ Markets': 'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
      'Wall Street Journal': 'https://feeds.a.dj.com/rss/RSSWSJD.xml',
      'CNBC': 'https://www.cnbc.com/id/100003114/device/rss/rss.html',
      'New York Times': 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
      'Washington Post': 'https://feeds.washingtonpost.com/rss/world',
      'ABC News': 'https://abcnews.go.com/abcnews/topstories',
      'NASA': 'https://www.nasa.gov/rss/dyn/breaking_news.rss',
      'Science Daily': 'https://www.sciencedaily.com/rss/top.xml',
      'Nature': 'https://www.nature.com/nature.rss'
    };

    function rgbToStr(arr) { return Array.isArray(arr) ? arr.join(',') : ''; }
    function strToRgb(s) { return s ? s.split(',').map(Number) : [0,0,0]; }

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type || '');
    }

    function getJson() {
      try { return JSON.parse(editor.value); } catch (_) { return null; }
    }

    function applyToEditor(updater) {
      const json = getJson();
      if (!json) { setStatus('Invalid JSON', 'error'); return; }
      updater(json);
      editor.value = JSON.stringify(json, null, 2);
    }

    function ensureColorOption(sel, val, label) {
      if (!val) return;
      if (!sel.querySelector('option[value="' + val + '"]')) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label || 'Custom';
        sel.appendChild(opt);
      }
    }

    function syncControlsFromJson() {
      const json = getJson();
      if (!json) return;
      const m = json.mode || 'clock_basic';
      if (modeSelect.querySelector('option[value="' + m + '"]')) modeSelect.value = m;
      const r = json.rotate || 'left';
      if (rotateSelect.querySelector('option[value="' + r + '"]')) rotateSelect.value = r;

      const screen = json.screen || {};
      const b = String(screen.brightness ?? 80);
      if (brightnessSelect.querySelector('option[value="' + b + '"]')) brightnessSelect.value = b;
      else brightnessSelect.value = '80';
      scheduleEnabled.value = screen.schedule_enabled ? 'true' : 'false';
      onTimeInput.value = screen.on_time || '07:00';
      offTimeInput.value = screen.off_time || '22:00';

      refreshSeconds.value = json.refresh_seconds || '';
      if (json.slideshow) secondsPerSlide.value = json.slideshow.seconds_per_slide || '';
      if (json.web_images) {
        secondsPerSlide.value = json.web_images.seconds_per_slide || secondsPerSlide.value;
        refreshListSeconds.value = json.web_images.refresh_list_seconds || '';
      }
      if (json.news_feed) {
        itemSeconds.value = json.news_feed.item_seconds || '';
        refreshNewsSeconds.value = json.news_feed.refresh_news_seconds || '';
        refreshStocksSeconds.value = json.news_feed.refresh_stocks_seconds || '';
        const tr = json.news_feed.transition || 'slide_left';
        if (transitionSelect.querySelector('option[value="' + tr + '"]')) transitionSelect.value = tr;
        transitionMs.value = json.news_feed.transition_ms || '';
        maxHeadlines.value = json.news_feed.max_headlines || '';
        const feeds = json.news_feed.rss_feeds || [];
        const presets = json.rss_feed_presets || RSS_PRESETS_DEFAULT;
        const presetUrls = Object.values(presets);
        const customUrls = feeds.filter(u => !presetUrls.includes(u));
        rssFeeds.value = customUrls.join('\n');
        rssPresets.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = feeds.includes(cb.dataset.url);
        });
        tickersInput.value = (json.news_feed.tickers || []).join('\n');
        const fc = rgbToStr(json.news_feed.clock_color_rgb) || rgbToStr(json.news_feed.text_color_rgb);
        ensureColorOption(fontColorSelect, fc, 'Custom');
        fontColorSelect.value = fc;
        const bc = rgbToStr(json.news_feed.bg_rgb);
        ensureColorOption(bgColorSelect, bc, 'Custom');
        bgColorSelect.value = bc;
        fontSelect.value = json.news_feed.clock_font_name || json.news_feed.text_font_name || 'dejavusans';
        fontSizeInput.value = json.news_feed.clock_font_size || '';
      } else if (json.clock_basic) {
        const fc = rgbToStr(json.clock_basic.color_rgb);
        ensureColorOption(fontColorSelect, fc, 'Custom');
        fontColorSelect.value = fc;
        const bc = rgbToStr(json.clock_basic.bg_rgb);
        ensureColorOption(bgColorSelect, bc, 'Custom');
        bgColorSelect.value = bc;
        fontSelect.value = json.clock_basic.font_name || 'dejavusans';
        fontSizeInput.value = json.clock_basic.font_size || '';
      } else if (json.slideshow && json.slideshow.clock) {
        const fc = rgbToStr(json.slideshow.clock.color_rgb);
        ensureColorOption(fontColorSelect, fc, 'Custom');
        fontColorSelect.value = fc;
        fontSelect.value = json.slideshow.clock.font_name || 'dejavusans';
        fontSizeInput.value = json.slideshow.clock.font_size || '';
      }
    }

    function applyModeFromDropdown() {
      applyToEditor(j => { j.mode = modeSelect.value; });
      syncControlsFromJson();
    }

    function applyRotateFromDropdown() {
      applyToEditor(j => { j.rotate = rotateSelect.value; });
    }

    function applyScreenSettings() {
      applyToEditor(j => {
        if (!j.screen) j.screen = {};
        j.screen.brightness = parseInt(brightnessSelect.value, 10);
        j.screen.schedule_enabled = scheduleEnabled.value === 'true';
        j.screen.on_time = onTimeInput.value || '07:00';
        j.screen.off_time = offTimeInput.value || '22:00';
      });
    }

    function applyFontColor() {
      const rgb = strToRgb(fontColorSelect.value);
      applyToEditor(j => {
        const m = modeSelect.value;
        if (m === 'news_feed' && j.news_feed) {
          j.news_feed.clock_color_rgb = rgb;
          j.news_feed.text_color_rgb = rgb;
        } else if (m === 'clock_basic' && j.clock_basic) j.clock_basic.color_rgb = rgb;
        else if (m === 'slideshow' && j.slideshow?.clock) j.slideshow.clock.color_rgb = rgb;
      });
    }

    function applyBgColor() {
      const rgb = strToRgb(bgColorSelect.value);
      applyToEditor(j => {
        const m = modeSelect.value;
        if (m === 'news_feed' && j.news_feed) j.news_feed.bg_rgb = rgb;
        else if (m === 'clock_basic' && j.clock_basic) j.clock_basic.bg_rgb = rgb;
      });
    }

    function applyFont() {
      const font = fontSelect.value;
      applyToEditor(j => {
        const m = modeSelect.value;
        if (m === 'news_feed' && j.news_feed) {
          j.news_feed.clock_font_name = font;
          j.news_feed.text_font_name = font;
        } else if (m === 'clock_basic' && j.clock_basic) j.clock_basic.font_name = font;
        else if (m === 'slideshow' && j.slideshow?.clock) j.slideshow.clock.font_name = font;
      });
    }

    function applyFontSize() {
      const size = parseInt(fontSizeInput.value, 10);
      if (isNaN(size)) return;
      applyToEditor(j => {
        const m = modeSelect.value;
        if (m === 'news_feed' && j.news_feed) {
          j.news_feed.clock_font_size = size;
          j.news_feed.text_font_size = Math.round(size * 0.22) || 60;
        } else if (m === 'clock_basic' && j.clock_basic) j.clock_basic.font_size = size;
        else if (m === 'slideshow' && j.slideshow?.clock) j.slideshow.clock.font_size = size;
      });
    }

    function applyRefreshIntervals() {
      applyToEditor(j => {
        if (refreshSeconds.value) j.refresh_seconds = parseInt(refreshSeconds.value, 10);
        if (j.slideshow && secondsPerSlide.value) j.slideshow.seconds_per_slide = parseInt(secondsPerSlide.value, 10);
        if (j.web_images) {
          if (secondsPerSlide.value) j.web_images.seconds_per_slide = parseInt(secondsPerSlide.value, 10);
          if (refreshListSeconds.value) j.web_images.refresh_list_seconds = parseInt(refreshListSeconds.value, 10);
        }
        if (j.news_feed) {
          if (itemSeconds.value) j.news_feed.item_seconds = parseInt(itemSeconds.value, 10);
          if (refreshNewsSeconds.value) j.news_feed.refresh_news_seconds = parseInt(refreshNewsSeconds.value, 10);
          if (refreshStocksSeconds.value) j.news_feed.refresh_stocks_seconds = parseInt(refreshStocksSeconds.value, 10);
          if (transitionMs.value) j.news_feed.transition_ms = parseInt(transitionMs.value, 10);
          if (maxHeadlines.value) j.news_feed.max_headlines = parseInt(maxHeadlines.value, 10);
          const presetUrls = [];
          rssPresets.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            presetUrls.push(cb.dataset.url);
          });
          const customUrls = rssFeeds.value.split('\n').map(s => s.trim()).filter(Boolean);
          j.news_feed.rss_feeds = presetUrls.concat(customUrls);
          const tickers = tickersInput.value.split(/[\n,]+/).map(s => s.trim().toUpperCase()).filter(Boolean);
          j.news_feed.tickers = tickers;
        }
      });
    }

    function populateFontsFromConfig(json) {
      const list = json.font_list || ['dejavusans','dejavusansmono','freesans','arial','verdana','tahoma','liberationsans'];
      fontSelect.innerHTML = list.map(f => '<option value="' + (f || '') + '">' + (f || 'default') + '</option>').join('');
    }

    function populateRssPresets(json) {
      const presets = json.rss_feed_presets || RSS_PRESETS_DEFAULT;
      rssPresets.innerHTML = '';
      for (const [label, url] of Object.entries(presets)) {
        const labelEl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.url = url;
        cb.addEventListener('change', applyRefreshIntervals);
        labelEl.appendChild(cb);
        labelEl.appendChild(document.createTextNode(label));
        rssPresets.appendChild(labelEl);
      }
    }

    async function load() {
      setStatus('Loading...', 'loading');
      try {
        const r = await fetch(CONFIG_URL);
        if (!r.ok) throw new Error(r.statusText);
        const json = await r.json();
        editor.value = JSON.stringify(json, null, 2);
        populateFontsFromConfig(json);
        populateRssPresets(json);
        syncControlsFromJson();
        setStatus('Loaded', 'success');
      } catch (e) {
        setStatus('Load failed: ' + e.message, 'error');
        editor.value = '{}';
      }
    }

    async function save() {
      let obj;
      try {
        obj = JSON.parse(editor.value);
      } catch (e) {
        setStatus('Invalid JSON: ' + e.message, 'error');
        return;
      }
      setStatus('Saving...', 'loading');
      saveBtn.disabled = true;
      try {
        const r = await fetch(CONFIG_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data.error || r.statusText);
        setStatus('Saved', 'success');
      } catch (e) {
        setStatus('Save failed: ' + e.message, 'error');
      } finally {
        saveBtn.disabled = false;
      }
    }

    saveBtn.addEventListener('click', save);
    reloadBtn.addEventListener('click', load);
    modeSelect.addEventListener('change', applyModeFromDropdown);
    rotateSelect.addEventListener('change', applyRotateFromDropdown);
    brightnessSelect.addEventListener('change', applyScreenSettings);
    scheduleEnabled.addEventListener('change', applyScreenSettings);
    onTimeInput.addEventListener('change', applyScreenSettings);
    offTimeInput.addEventListener('change', applyScreenSettings);
    offTimeInput.addEventListener('blur', applyScreenSettings);
    fontColorSelect.addEventListener('change', applyFontColor);
    bgColorSelect.addEventListener('change', applyBgColor);
    fontSelect.addEventListener('change', applyFont);
    fontSizeInput.addEventListener('change', applyFontSize);
    fontSizeInput.addEventListener('blur', applyFontSize);
    transitionSelect.addEventListener('change', applyRefreshIntervals);
    [refreshSeconds, secondsPerSlide, refreshListSeconds, itemSeconds, refreshNewsSeconds, refreshStocksSeconds, transitionMs, maxHeadlines].forEach(el => {
      if (el) el.addEventListener('change', applyRefreshIntervals);
      if (el && el.tagName === 'INPUT') el.addEventListener('blur', applyRefreshIntervals);
    });
    rssFeeds.addEventListener('blur', applyRefreshIntervals);
    tickersInput.addEventListener('blur', applyRefreshIntervals);
    editor.addEventListener('input', syncControlsFromJson);
    load();

    // Photo upload
    const uploadZone = document.getElementById('uploadZone');
    const photoInput = document.getElementById('photoInput');
    const uploadStatus = document.getElementById('uploadStatus');

    uploadZone.addEventListener('click', () => photoInput.click());
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) doUpload(e.dataTransfer.files);
    });
    photoInput.addEventListener('change', (e) => {
      if (e.target.files.length) doUpload(e.target.files);
      e.target.value = '';
    });

    async function doUpload(files) {
      const formData = new FormData();
      for (let i = 0; i < Math.min(files.length, 20); i++) {
        if (files[i].type.startsWith('image/')) formData.append('photos', files[i]);
      }
      if (!formData.getAll('photos').length) {
        uploadStatus.textContent = 'No valid image files selected.';
        uploadStatus.className = 'upload-status error';
        return;
      }
      uploadStatus.textContent = 'Uploading...';
      uploadStatus.className = 'upload-status';
      try {
        const r = await fetch('/tomopi/images/upload', { method: 'POST', body: formData });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data.error || r.statusText);
        const count = (data.uploaded || []).length;
        uploadStatus.textContent = 'Uploaded ' + count + ' photo(s) to /tomopi/images';
        uploadStatus.className = 'upload-status success';
      } catch (e) {
        uploadStatus.textContent = 'Upload failed: ' + e.message;
        uploadStatus.className = 'upload-status error';
      }
    }
  </script>
</body>
</html>
