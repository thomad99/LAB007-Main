<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB007 - Citrix Audit Dashboard v2</title>
    <link rel="icon" type="image/png" href="images/lab007%20Icon.PNG">
    <link rel="shortcut icon" type="image/png" href="images/lab007%20Icon.PNG">
    <link rel="apple-touch-icon" href="images/lab007%20Icon.PNG">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
    // early stub to avoid undefined onclick; replaced later in main script
    window.openUagModal = function() {
        const modal = document.getElementById('uagModal');
        if (modal) modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    };
    window.closeUagModal = function() {
        const modal = document.getElementById('uagModal');
        if (modal) modal.style.display = 'none';
        document.body.style.overflow = '';
    };
    window.showUagTab = function(tab){
        ['config','debug','diagram'].forEach(t=>{
            const panel = document.getElementById(`uag${t.charAt(0).toUpperCase()+t.slice(1)}Panel`);
            const btn = document.getElementById(`uagTab${t.charAt(0).toUpperCase()+t.slice(1)}`);
            if (panel) panel.style.display = (t===tab)?'block':'none';
            if (btn) btn.classList.toggle('active', t===tab);
        });
    };
    </script>
    <style>
    .chip {
        display:inline-block;
        padding:6px 10px;
        border-radius:16px;
        background:rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);
        margin:4px;
        font-size:12px;
    }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .spinner-eye {
        display:inline-block;
        width:20px;
        height:20px;
        border-radius:50%;
        border:3px solid rgba(34,211,238,0.25);
        border-top-color:#22d3ee;
        animation: spin 0.8s linear infinite;
        vertical-align:middle;
        margin-right:6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .log-entry { border:1px solid rgba(255,255,255,0.08); border-radius:8px; margin-bottom:6px; background:#0f172a; }
    .log-head { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; cursor:pointer; font-weight:700; }
    .log-toggle { font-weight:900; color:#e5b600; margin-left:10px; }
    .log-body { display:none; border-top:1px solid rgba(255,255,255,0.08); max-height:80vh; overflow:auto; }
    .log-body pre { white-space:pre; max-height:none; overflow:visible; font-size:12px; color:#cbd5e1; margin:0; padding:8px 10px; }
    .log-match { background:#fde047; color:#111; font-weight:700; padding:1px 2px; border-radius:3px; }
    .log-match.active { background:#22d3ee; color:#0b1020; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <img src="/citrix/images/LAB007-LOGO-GOLD.png" alt="LAB007 Logo" class="logo" style="opacity: 1;">
                <div class="header-title">
                    <p class="header-subtitle" style="margin: 0;">
                        <span class="header-title-main">Citrix Environment</span><br>
                        <span class="header-title-sub">Audit Dashboard</span>
                    </p>
                </div>
            </div>
            <div class="refresh-controls" style="z-index: 9999; position: relative; display: flex; flex-wrap: nowrap; gap: 6px; justify-content: space-between; align-items: flex-start; width: 100%; padding: 0 4px; font-size: 12px; overflow-x: auto;">
                <div style="display: flex; flex-direction: column; gap: 2px; min-width: 220px; align-items: stretch; flex: 1.5 1 0;">
                    <div style="text-align: center; color: #dcdcdc; letter-spacing: 2px; font-weight: 600;">Discover</div>
                    <div style="border: 2px solid #dcdcdc; border-radius: 10px; padding: 4px; display: flex; flex-wrap: nowrap; gap: 4px; align-items: center; justify-content: center; background: rgba(255,255,255,0.04); overflow-x:auto;">
                    <a href="/citrix/api/download-audit-files" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; font-size: 12px; padding: 8px 14px; min-height: 38px; background:#e5b600; border-color:#e5b600; color:#000;">Download Tools</a>
                    <div class="file-input-wrapper" style="display: inline-block; position: relative;">
                        <button id="loadFileBtn" class="btn btn-primary" style="z-index: 10000; font-size: 12px; padding: 8px 14px; min-height: 38px; background:#e5b600; border-color:#e5b600; color:#000;" title="Load 0-Citrix-audit*.json or Citrix export ZIP files">Load Audit</button>
                        <input type="file" id="fileInput" accept=".json,.zip" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    </div>
                    <button onclick="window.location.href='netscaler.html'" class="btn btn-secondary" style="background: #e5b600; border-color: #e5b600; color: #000; font-size: 12px; padding: 8px 14px; min-height: 38px;">NetScaler Config</button>
                    <button id="configBtn" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 8px 14px; min-height: 38px; background:#e5b600; border-color:#e5b600; color:#000;">
                        <img src="images/lab007 Icon.PNG" alt="LAB007" style="height: 16px; width: 16px; object-fit: contain;">
                        Config
                    </button>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 2px; min-width: 120px; align-items: stretch; flex: 0.7 1 0;">
                    <div style="text-align: center; color: #dcdcdc; letter-spacing: 2px; font-weight: 600;">Build</div>
                    <div style="border: 2px solid #dcdcdc; border-radius: 10px; padding: 4px; display: flex; flex-wrap: nowrap; gap: 4px; align-items: center; justify-content: center; background: rgba(255,255,255,0.04); overflow-x:auto;">
                        <button onclick="window.location.href='todo.html'" class="btn btn-secondary" style="background: #17a2b8; border-color: #17a2b8; font-size: 12px; padding: 8px 14px; min-height: 38px;">Build</button>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 2px; min-width: 200px; align-items: stretch; flex: 1.2 1 0;">
                    <div style="text-align: center; color: #dcdcdc; letter-spacing: 2px; font-weight: 600;">Manage</div>
                    <div style="border: 2px solid #dcdcdc; border-radius: 10px; padding: 6px; display: flex; flex-wrap: nowrap; gap: 4px; align-items: center; justify-content: center; background: rgba(255,255,255,0.04); overflow-x:auto;">
                    <button id="goldenSunBtn" class="btn btn-secondary" style="background: linear-gradient(135deg,#1f8e3d,#32a852); border-color: #1f8e3d; font-size: 12px; padding: 8px 14px; min-height: 38px;">GoldenSun</button>
                    <button id="horizonTasksBtn" class="btn btn-primary" style="font-size: 12px; padding: 8px 14px; min-height: 38px; background:#e5b600; border-color:#e5b600; color:#000;">HZ Tasks</button>
                    <button onclick="openUagModal()" class="btn btn-secondary" style="background:#e5b600;border-color:#e5b600;color:#000;font-size:12px;padding:8px 14px;min-height:38px;">UAG</button>
                    <button id="uploadDebugBtn" class="btn btn-secondary" style="background: #e5b600; color: #000; border-color: #e5b600; z-index: 10000; font-size: 12px; padding: 8px 14px; min-height: 38px;">Upload Debugs</button>
                    </div>
                </div>
            </div>
        </header>

        <div id="loadingIndicator" class="loading">
            <img src="images/LAB007-Loader.png" alt="Loading..." class="loader-spinner">
            <p id="loadingText" class="loading-text">Awaiting your command</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- Global Search -->
            <section class="global-search-section">
                <div class="global-search-container">
                    <input type="text" id="globalSearch" placeholder="Search across all data..." class="global-search-input">
                    <button id="clearSearchBtn" class="btn btn-secondary" style="display: none;" onclick="clearGlobalSearch()">Clear</button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </section>

            <!-- Summary Cards -->
            <section class="summary-section">
                <h2>Environment Overview</h2>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-content">
                            <h3>Site Name</h3>
                            <p class="card-value" id="siteName">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="appsCard" onclick="showAppDetails()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Published Applications</h3>
                            <p class="card-value" id="totalApps">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="desktopsCard" onclick="showDesktopList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Published Desktops</h3>
                            <p class="card-value" id="totalDesktops">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="usersCard" onclick="showUserList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Max Concurrent Users (30d)</h3>
                            <p class="card-value" id="maxConcurrent">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="catalogsCard" onclick="showCatalogList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Catalogs</h3>
                            <p class="card-value" id="numCatalogs">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="deliveryGroupsCard" onclick="showDeliveryGroupList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Delivery Groups</h3>
                            <p class="card-value" id="numDeliveryGroups">-</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <h3>Unique Users (30d)</h3>
                            <p class="card-value" id="uniqueUsers">-</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <h3>Total Servers</h3>
                            <p class="card-value" id="totalServers">-</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <h3>License Type</h3>
                            <p class="card-value" id="licenseType">-</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <h3>Controllers</h3>
                            <p class="card-value" id="controllerCount">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="masterImagesCard" onclick="showMasterImagesList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>Master Images</h3>
                            <p class="card-value" id="totalMasterImages">-</p>
                        </div>
                    </div>
                    <div class="card clickable-card" id="storefrontStoresCard" onclick="showStoreFrontStoresList()" style="cursor: pointer;">
                        <div class="card-content">
                            <h3>StoreFront Stores</h3>
                            <p class="card-value" id="totalStoreFrontStores">-</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Servers Section -->
            <section class="servers-section collapsible collapsed">
                <div class="section-header">
                    <h2>Server Details</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportServersCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="search-filter">
                        <input type="text" id="serverSearch" placeholder="Search servers..." class="search-input">
                    </div>
                    <div class="table-container">
                        <table id="serversTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Server Name</th>
                                    <th class="sortable" data-column="1">Power State</th>
                                    <th class="sortable" data-column="2">Registration State</th>
                                    <th class="sortable" data-column="3">Total RAM (GB)</th>
                                    <th class="sortable" data-column="4">CPU Cores</th>
                                    <th class="sortable" data-column="5">CPU Logical</th>
                                    <th class="sortable" data-column="6">Disk Total (GB)</th>
                                    <th class="sortable" data-column="7">Disk Free (GB)</th>
                                    <th class="sortable" data-column="8">OS Version</th>
                                    <th class="sortable" data-column="9">Desktop Group</th>
                                    <th class="sortable" data-column="10">Specs Source</th>
                                </tr>
                            </thead>
                            <tbody id="serversTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Applications Section -->
            <section class="applications-section collapsible collapsed">
                <div class="section-header">
                    <h2>Published Applications</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportAppsCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="search-filter">
                        <input type="text" id="appSearch" placeholder="Search applications..." class="search-input">
                    </div>
                    <div class="table-container">
                        <table id="appsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Application Name</th>
                                    <th class="sortable" data-column="1">Published Name</th>
                                    <th class="sortable" data-column="2">Desktop Group</th>
                                    <th class="sortable" data-column="3">Enabled</th>
                                    <th class="sortable" data-column="4">Description</th>
                                </tr>
                            </thead>
                            <tbody id="appsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Delivery Groups Section -->
            <section class="delivery-groups-section collapsible collapsed">
                <div class="section-header">
                    <h2>Delivery Groups</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportDeliveryGroupsCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table id="deliveryGroupsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Name</th>
                                    <th class="sortable" data-column="1">Desktop Kind</th>
                                    <th class="sortable" data-column="2">Session Support</th>
                                    <th class="sortable" data-column="3">Total Machines</th>
                                    <th class="sortable" data-column="4">Available</th>
                                    <th class="sortable" data-column="5">In Use</th>
                                    <th class="sortable" data-column="6">Total Applications</th>
                                    <th class="sortable" data-column="7">Restart Schedule</th>
                                    <th class="sortable" data-column="8">Maintenance Mode</th>
                                    <th class="sortable" data-column="9">Enabled</th>
                                </tr>
                            </thead>
                            <tbody id="deliveryGroupsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Catalogs Section -->
            <section class="catalogs-section collapsible collapsed">
                <div class="section-header">
                    <h2>Machine Catalogs</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportCatalogsCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table id="catalogsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Name</th>
                                    <th class="sortable" data-column="1">Allocation Type</th>
                                    <th class="sortable" data-column="2">Provisioning Type</th>
                                    <th class="sortable" data-column="3">Session Support</th>
                                    <th class="sortable" data-column="4">Total Count</th>
                                    <th class="sortable" data-column="5">Available</th>
                                    <th class="sortable" data-column="6">In Use</th>
                                    <th class="sortable" data-column="7">Persist User Changes</th>
                                </tr>
                            </thead>
                            <tbody id="catalogsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Policies Section -->
            <section class="policies-section collapsible collapsed">
                <div class="section-header">
                    <h2>Citrix Policies</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportPoliciesCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table id="policiesTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Name</th>
                                    <th class="sortable" data-column="1">Enabled</th>
                                    <th class="sortable" data-column="2">Priority</th>
                                    <th class="sortable" data-column="3">Is Assigned</th>
                                    <th class="sortable" data-column="4">Description</th>
                                </tr>
                            </thead>
                            <tbody id="policiesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Roles Section -->
            <section class="roles-section collapsible collapsed">
                <div class="section-header">
                    <h2>Management Roles & AD Groups</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary section-toggle-btn" onclick="toggleSection(this)" aria-label="Toggle section">▼</button>
                        <button class="btn btn-primary" onclick="exportRolesCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="table-container">
                        <table id="rolesTable" class="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="0">Role Name</th>
                                    <th class="sortable" data-column="1">Description</th>
                                    <th class="sortable" data-column="2">Is Built-In</th>
                                    <th class="sortable" data-column="3">AD Groups</th>
                                    <th class="sortable" data-column="4">Users</th>
                                    <th class="sortable" data-column="5">Scopes</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- UAG Modal -->
    <div id="uagModal" class="modal" style="display:none; position:fixed; inset:0; overflow:hidden;">
        <div class="modal-content" style="max-width: 96%; width: 96%; margin-top: 120px; background:#0b1020; color:#e2e8f0; height: calc(100vh - 140px); max-height: calc(100vh - 140px); display:flex; flex-direction:column; overflow:hidden;">
            <h2 style="margin:0 0 6px 0;">UAG Config Analyzer</h2>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <button class="task-tab active" id="uagTabConfig" onclick="showUagTab('config')">Config Dashboard</button>
                <button class="task-tab" id="uagTabDebug" onclick="showUagTab('debug')">Debug / Logs</button>
                <button class="task-tab" id="uagTabDiagram" onclick="showUagTab('diagram')">Diagram (Manual)</button>
            </div>

            <div id="uagModalBody" style="flex:1 1 auto; overflow:auto; padding-right:4px;">

            <div id="uagConfigPanel" class="horizon-task-panel" style="display:block;">
                <h3>Import UAG Config</h3>
                <input type="file" id="uagConfigFile" accept=".txt,.conf,.cfg,.ini,.log,.json" class="btn btn-secondary" style="background:#e5b600; color:#000; border:1px solid #e5b600; padding:10px 12px; min-height:44px; font-size:14px; height:44px; box-sizing:border-box;">
                <div id="uagConfigStatus" style="margin-top:8px; color:#94a3b8;"></div>

                <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:8px; margin:12px 0;">
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">Gateways</div><div id="uagStatGateways" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">Connection Servers</div><div id="uagStatConn" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">DNS</div><div id="uagStatDns" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">AD / Entra</div><div id="uagStatAd" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">Certs</div><div id="uagStatCerts" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;"><div style="font-size:12px; color:#94a3b8;">External URLs</div><div id="uagStatExt" style="font-weight:800; font-size:18px; color:#e5b600;">0</div></div>
                </div>

                <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:8px; margin-bottom:12px;">
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">UAG Name</div>
                        <div id="uagMetaName" style="font-weight:700; font-size:15px; color:#e5b600; overflow-wrap:anywhere;">-</div>
                    </div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">UAG IP</div>
                        <div id="uagMetaIp" style="font-weight:700; font-size:15px; color:#e5b600; overflow-wrap:anywhere;">-</div>
                    </div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">Connection Server</div>
                        <div id="uagMetaCsUrl" style="font-weight:700; font-size:15px; color:#e5b600; overflow-wrap:anywhere;">-</div>
                    </div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">Conn Server Thumbprint</div>
                        <div id="uagMetaThumb" style="font-weight:700; font-size:15px; color:#e5b600; overflow-wrap:anywhere;">-</div>
                    </div>
                    <div class="card" style="padding:10px; min-height:60px; background:#11182a; color:#e2e8f0;">
                        <div style="font-size:12px; color:#94a3b8;">Max Blast Connections</div>
                        <div id="uagMetaBlast" style="font-weight:700; font-size:15px; color:#e5b600; overflow-wrap:anywhere;">-</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;">
                    <div class="card" style="min-height:160px; background:#11182a;">
                        <h4>Gateways / External</h4>
                        <div id="uagListGateway" class="chips"></div>
                    </div>
                    <div class="card" style="min-height:160px; background:#11182a;">
                        <h4>Connection Servers</h4>
                        <div id="uagListConn" class="chips"></div>
                    </div>
                    <div class="card" style="min-height:160px; background:#11182a;">
                        <h4>DNS / AD</h4>
                        <div id="uagListDns" class="chips"></div>
                        <div id="uagListAd" class="chips" style="margin-top:6px;"></div>
                    </div>
                    <div class="card" style="min-height:160px; background:#11182a;">
                        <h4>Certificates</h4>
                        <div id="uagListCerts" class="chips"></div>
                    </div>
                </div>
            </div>

            <div id="uagDebugPanel" class="horizon-task-panel" style="display:none;">
                <h3>Debug / Logs</h3>
                <div style="position: sticky; top: 56px; z-index: 3000; background:#0b1020; padding:8px 4px 14px 4px; border-bottom:1px solid rgba(255,255,255,0.08);">
                    <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;">
                        <div style="flex:1 1 420px; min-width:320px; min-height:76px;">
                            <input type="file" id="uagLogFile" accept=".zip" class="btn btn-secondary" style="background:#e5b600; color:#000; border:1px solid #e5b600; padding:6px 10px; min-height:34px;">
                    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                <input id="uagLogSearch" class="input" style="max-width:260px; min-height:38px; padding:8px 10px;" placeholder="Search text in logs...">
                                <button class="btn" id="uagLogSearchBtn">Search</button>
                                <button class="btn" id="uagLogPrevBtn" title="Previous match">Prev</button>
                                <button class="btn" id="uagLogNextBtn" title="Next match">Next</button>
                                <span id="uagLogCount" style="color:#94a3b8;">0</span>
                        <select id="uagLogLevel" class="input" style="min-height:38px; padding:6px 8px;">
                            <option value="all">All</option>
                            <option value="info">[INFO]</option>
                            <option value="debug">[DEBUG]</option>
                            <option value="warn">[WARN]</option>
                            <option value="error">[ERROR]</option>
                        </select>
                            </div>
                        </div>
                        <div style="flex:1 1 420px; min-width:340px; display:flex; gap:8px; align-items:stretch; min-height:76px;">
                            <textarea id="uagAiInput" rows="3" placeholder="Paste an error snippet to analyze..." style="flex:1 1 auto; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:#0f172a; color:#e2e8f0; min-height:80px;"></textarea>
                            <div style="display:flex; flex-direction:column; gap:6px; min-width:120px; align-items:stretch;">
                                <button class="btn btn-secondary" id="uagAiBtn" style="background:#22d3ee; border-color:#22d3ee; color:#0b1020; min-height:38px;">AI Analyze</button>
                                <div id="uagAiStatus" style="color:#94a3b8; font-size:12px; min-height:18px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="uagAiResult" style="margin-top:10px; border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:10px; background:#0f172a; color:#e2e8f0; display:none; position:relative; z-index:1;"></div>
                <div id="uagLogStatus" style="margin-top:8px;color:#94a3b8;"></div>
                <div class="logs" id="uagLogResults" style="margin-top:10px; overflow:auto; max-height:70vh;"></div>

                <h3 style="margin-top:18px;">Connection Server Bundle</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
                    <div>
                        <label style="color:#cbd5e1; display:block; margin-bottom:4px;">Upload CS Bundle (.zip)</label>
                        <input type="file" id="csBundleFile" accept=".zip" class="btn btn-secondary" style="background:#e5b600; color:#000; border:1px solid #e5b600; padding:6px 10px; min-height:34px;">
                    </div>
                    <div>
                        <label style="color:#cbd5e1; display:block; margin-bottom:4px;">Upload Any File (store)</label>
                        <input type="file" id="csAnyFile" class="btn btn-secondary" style="background:#e5b600; color:#000; border:1px solid #e5b600; padding:6px 10px; min-height:34px;">
                    </div>
                </div>
                <div id="csBundleStatus" style="color:#94a3b8; margin-bottom:8px;"></div>
                <div id="csBundleSummary" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;"></div>
                <div id="csBundleResults" style="border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:8px; background:#0f172a; max-height:420px; overflow:auto;"></div>
            </div>

            <div id="uagDiagramPanel" class="horizon-task-panel" style="display:none;">
                <h3>Manual Diagram</h3>
                <p style="color:#94a3b8; margin-top:0;">Enter values (comma separated) to draw a quick UAG topology.</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">External DNS Name</label>
                            <input id="uagManualExternalDns" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="horizon.example.com, uag.example.com">
                        </div>
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">DMZ NLB IP</label>
                            <input id="uagManualDmzLb" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="203.0.113.10, 203.0.113.11">
                        </div>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">UAG Names</label>
                            <input id="uagManualUag" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="uag01, uag02">
                        </div>
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">UAG IPs</label>
                            <input id="uagManualUagIp" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="10.0.0.11, 10.0.0.12">
                        </div>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">Internal NLB IP</label>
                            <input id="uagManualInternalLb" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="10.0.1.20">
                        </div>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">Connection Server Names</label>
                            <input id="uagManualConn" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="conn01, conn02">
                        </div>
                        <div style="flex:1 1 0; min-width:320px;">
                            <label style="display:block; color:#cbd5e1; margin-bottom:6px;">Connection Server IPs</label>
                            <input id="uagManualConnIp" class="input" style="min-height:44px; padding:10px; width:100%;" maxlength="200" placeholder="10.0.1.31, 10.0.1.32">
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="margin-top:10px; background:#22d3ee; border-color:#22d3ee; color:#0b1020;" onclick="renderManualDiagram()">Draw Diagram</button>
                <div id="uagManualStatus" style="margin-top:8px; color:#94a3b8;"></div>
                <div id="uagManualDiagramWrap" style="margin-top:12px; background:#0f172a; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:10px; min-height:240px; overflow:auto;">
                    <div id="uagManualMermaid">Enter details and click Draw.</div>
                </div>
            </div>
            </div> <!-- end uagModalBody -->
        </div>
    </div>

    <!-- Modal for Catalog List -->
    <div id="catalogModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCatalogModal()">&times;</span>
            <h2>All Catalog Names</h2>
            <div id="catalogListContent"></div>
        </div>
    </div>

    <!-- Modal for Desktop List -->
    <div id="desktopsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDesktopsModal()">&times;</span>
            <h2>Published Desktops</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Desktop Kind</th>
                            <th>Session Support</th>
                            <th>Total Machines</th>
                            <th>Available</th>
                            <th>In Use</th>
                            <th>Maintenance Mode</th>
                            <th>Enabled</th>
                        </tr>
                    </thead>
                    <tbody id="desktopsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Delivery Group List -->
    <div id="deliveryGroupsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 95%;">
            <span class="modal-close" onclick="closeDeliveryGroupsModal()">&times;</span>
            <h2>Delivery Groups</h2>
            <div class="table-container">
                <table id="deliveryGroupsModalTable" class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="0">Name</th>
                            <th class="sortable" data-column="1">Desktop Kind</th>
                            <th class="sortable" data-column="2">Session Support</th>
                            <th class="sortable" data-column="3">Total Machines</th>
                            <th class="sortable" data-column="4">Available</th>
                            <th class="sortable" data-column="5">In Use</th>
                            <th class="sortable" data-column="6">Total Applications</th>
                            <th class="sortable" data-column="7">Restart Schedule</th>
                            <th class="sortable" data-column="8">Maintenance Mode</th>
                            <th class="sortable" data-column="9">Enabled</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryGroupsModalTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for User List -->
    <div id="usersModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeUsersModal()">&times;</span>
            <h2>User Connections (30 days)</h2>
            <div id="usersListContent"></div>
        </div>
    </div>

    <!-- Modal for Master Images -->
    <div id="masterImagesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%;">
            <span class="modal-close" onclick="closeMasterImagesModal()">&times;</span>
            <h2>Master Images</h2>
            <div class="table-container">
                <table id="masterImagesTable" class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="0">Cluster Name</th>
                            <th class="sortable" data-column="1">VM Name</th>
                            <th class="sortable" data-column="2">Snapshot Name</th>
                            <th class="sortable" data-column="3">Catalogs Using This Image</th>
                        </tr>
                    </thead>
                    <tbody id="masterImagesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for StoreFront Stores -->
    <div id="storeFrontStoresModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%;">
            <span class="modal-close" onclick="closeStoreFrontStoresModal()">&times;</span>
            <h2>StoreFront Stores</h2>
            <div class="table-container">
                <table id="storeFrontStoresTable" class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="0">Store Name</th>
                            <th class="sortable" data-column="1">Base URL</th>
                            <th class="sortable" data-column="2">Farm Name</th>
                            <th class="sortable" data-column="3">Virtual Path</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="storeFrontStoresTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for App Details -->
    <div id="appModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%;">
            <span class="modal-close" onclick="closeAppModal()">&times;</span>
            <h2>Application Details</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Application Name</th>
                            <th>Published Name</th>
                            <th>Run Path</th>
                            <th>Arguments</th>
                            <th>Working Directory</th>
                            <th>Assigned Users</th>
                            <th>Assigned Groups</th>
                            <th>Desktop Group</th>
                            <th>Enabled</th>
                        </tr>
                    </thead>
                    <tbody id="appDetailsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Horizon Environment Tasks -->
    <div id="horizonTasksModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 95%;">
            <span class="modal-close" onclick="closeHorizonTasksModal()">&times;</span>
            <h2>HZ Builds</h2>
            <div id="horizonTasksContent">
                <!-- Task navigation tabs will be added here -->
                <div id="horizonTasksTabs" style="border-bottom: 2px solid #ddd; margin-bottom: 20px;">
                    <button class="task-tab active" onclick="showHorizonTask('masterImageSearch')">Master Image Search</button>
                    <button class="task-tab" onclick="showHorizonTask('cloneMasterImage')">Clone Master Image</button>
                    <button class="task-tab" onclick="showHorizonTask('addApplications')">Add Applications to HZ</button>
                    <button class="task-tab" onclick="showHorizonTask('adminTasks')">Admin</button>
                    <!-- More tasks can be added here -->
                </div>
                

                <!-- Clone Master Image Task -->
                <div id="cloneMasterImageTask" class="horizon-task-panel active">
                    <h3>Clone Master Image</h3>
                    <p>First load a master images JSON file from the Master Image Search tab, then select which images to clone.</p>

                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                        <h4 style="margin-bottom: 10px;">Load Master Images List</h4>
                        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Load master images from a JSON file created by the discovery script to select which ones to clone.</p>
                        <button id="loadCloneMasterImagesBtn" class="btn btn-secondary" onclick="loadCloneMasterImagesFile()">Load Master Images JSON</button>
                        <input type="file" id="cloneMasterImagesFileInput" accept=".json" style="display: none;">
                        <span id="cloneMasterImagesFileName" style="margin-left: 15px; color: #666;"></span>
                    </div>


                    <div id="cloneImagesSection" style="margin: 20px 0; display: none;">
                        <h4 style="margin-bottom: 10px;">Master Images:</h4>
                        <div id="masterImagesCloneList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f9fa;">
                            <p>Loading master images...</p>
                        </div>
                    </div>

                    <div id="cloneScriptSection" style="margin: 20px 0; display: none;">
                        <h4 style="margin-bottom: 15px;">Clone Destination Configuration</h4>

                        <!-- Push Windows Update Toggle -->
                        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 240px;">
                                    <h5 style="margin: 0 0 5px 0; font-weight: bold;">Push Windows Update (On / Off)</h5>
                                    <p style="margin: 0; color: #666; font-size: 14px;">Default ON. When ON, cloned VMs power on and run mspatch.ps1 to install updates.</p>
                                </div>
                                <label class="toggle-switch" aria-label="Push Windows Update">
                                    <input type="checkbox" id="pushWindowsUpdateToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- VMware Folder Operations Toggle -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 240px;">
                                    <h5 style="margin: 0 0 5px 0; font-weight: bold;">Change VMware Folders (On / Off)</h5>
                                    <p style="margin: 0; color: #666; font-size: 14px;">Default OFF. When OFF, no VMware folder changes are made.</p>
                                </div>
                                <label class="toggle-switch" aria-label="Change VMware Folders">
                                    <input type="checkbox" id="enableVMwareFoldersToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div id="vmwareFoldersSection" style="display: none;">
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <h4 style="margin-bottom: 10px;">Load VMware Folders List</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Load VMware folder structure from a JSON file created by the VMware folders collection script to enable folder browsing.</p>
                                <button id="loadVMwareFoldersBtn" class="btn btn-secondary" onclick="loadVMwareFoldersFile()">Load VMware Folders JSON</button>
                                <input type="file" id="vmwareFoldersFileInput" accept=".json" style="display: none;">
                                <span id="vmwareFoldersFileName" style="margin-left: 15px; color: #666;"></span>
                            </div>

                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <label for="cloneDestinationFolder" style="display: block; margin-bottom: 8px; font-weight: bold;">VMware Destination Folder:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="cloneDestinationFolder" placeholder="Configured from LAB007-Config.JSON" style="flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;" readonly>
                                    <button id="browseCloneFoldersBtn" class="btn btn-secondary" style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;" disabled>Browse</button>
                                </div>
                                <p style="margin-top: 5px; color: #666; font-size: 12px;">Destination folder is configured in LAB007-Config.JSON. Use the Config tab to change folder settings.</p>
                            </div>

                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Source VM Move Options:</label>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="moveSourceAfterClone" style="margin-right: 8px;">
                                        Move source VMs to folder after cloning
                                    </label>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="sourceMoveFolder" placeholder="Configured from LAB007-Config.JSON" style="flex: 1; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #f5f5f5;" readonly>
                                    <button id="browseSourceFoldersBtn" class="btn btn-secondary" style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;" disabled>Browse</button>
                                </div>
                                <p style="margin-top: 5px; color: #666; font-size: 12px;">Source move folder is configured in LAB007-Config.JSON. Use the Config tab to change folder settings.</p>
                            </div>
                        </div>

                        <div style="text-align: right;">
                            <button id="createCloneScriptBtn" class="btn btn-primary" onclick="createCloneScript()">Create Script</button>
                        </div>
                    </div>
                    
                    <div id="cloneScriptOutput" style="display: none; margin-top: 20px;">
                        <h4>Generated Script:</h4>
                        <textarea id="cloneScriptContent" readonly style="width: 100%; height: 400px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                        <div style="margin-top: 10px; text-align: right;">
                            <button class="btn btn-secondary" onclick="copyCloneScript()">Copy Script</button>
                            <button class="btn btn-secondary" onclick="downloadCloneScript()">Download Script</button>
                        </div>
                    </div>
                </div>

                <!-- Master Image Search Task -->
                <div id="masterImageSearchTask" class="horizon-task-panel">
                    <h3>Master Image Search</h3>
                    <p>Configure and generate a VMware master image discovery script with your specific settings.</p>

                    <div style="margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="searchVCenterServer" style="display: block; margin-bottom: 8px; font-weight: bold;">vCenter Server:</label>
                                <input type="text" id="searchVCenterServer" placeholder="shcvcsacx01v.ccr.cchcs.org" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="margin-top: 5px; color: #666; font-size: 12px;">Configure in Settings → Configure Audit</p>
                            </div>
                            <div>
                                <label for="searchMasterPrefix" style="display: block; margin-bottom: 8px; font-weight: bold;">Master Image Prefix:</label>
                                <input type="text" id="searchMasterPrefix" placeholder="SHC-M-" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="margin-top: 5px; color: #666; font-size: 12px;">Images will be searched using: [Prefix]* pattern</p>
                            </div>
                        </div>

                        <div style="margin: 20px 0; text-align: right;">
                            <button id="createSearchScriptBtn" class="btn btn-primary" onclick="createMasterImageSearchScript()">Generate Search Script</button>
                        </div>

                        <div id="searchScriptOutput" style="display: none; margin-top: 20px;">
                            <h4>Generated VMware Master Image Search Script:</h4>
                            <p style="color: #666; margin-bottom: 10px;">This script will connect to your specified vCenter server and search for master images matching your criteria.</p>
                            <textarea id="searchScriptContent" readonly style="width: 100%; height: 400px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                            <div style="margin-top: 10px; text-align: right;">
                                <button class="btn btn-secondary" onclick="copySearchScript()">Copy Script</button>
                                <button class="btn btn-secondary" onclick="downloadSearchScript()">Download Script</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Applications to HZ Task -->
                <div id="addApplicationsTask" class="horizon-task-panel">
                    <h3>Add Applications to HZ</h3>
                    <p>Select applications from Citrix to generate Horizon commands for adding them to Horizon.</p>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 10px;">Applications:</h4>
                        <div id="applicationsHZList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                            <p>Loading applications...</p>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: right;">
                        <button id="createAppCommandsBtn" class="btn btn-primary" onclick="createHorizonAppCommands()">Create Commands</button>
                    </div>
                    
                    <div id="appCommandsOutput" style="display: none; margin-top: 20px;">
                        <h4>Generated Horizon Commands:</h4>
                        <textarea id="appCommandsContent" readonly style="width: 100%; height: 400px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                        <div style="margin-top: 10px; text-align: right;">
                            <button class="btn btn-secondary" onclick="copyAppCommands()">Copy Commands</button>
                            <button class="btn btn-secondary" onclick="downloadAppCommands()">Download Script</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Tasks -->
                <div id="adminTasksTask" class="horizon-task-panel">
                    <h3>Admin (Horizon REST)</h3>
                    <p style="color: #666;">Generate PowerShell scripts that authenticate and call Horizon REST APIs, then save results to JSON/YAML and print to screen.</p>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin: 10px 0 15px 0;">
                        <div>
                            <label for="adminHorizonBase" style="font-weight: 600;">Horizon Controller Address</label>
                            <input type="text" id="adminHorizonBase" value="https://horizon.steward.org" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666;">Used for all Admin scripts (REST base URL)</small>
                        </div>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0 20px 0;">
                        <button class="btn btn-secondary" onclick="generateHorizonAdminScript('farms')">FARM Data</button>
                        <button class="btn btn-secondary" onclick="generateHorizonAdminScript('desktops')">Desktops</button>
                        <button class="btn btn-secondary" onclick="generateHorizonAdminScript('restarts')">Restarts</button>
                        <button class="btn btn-secondary" onclick="generateHorizonAdminScript('clones')">Clones</button>
                        <button class="btn btn-secondary" onclick="generateHorizonAdminScript('imageDates')">Image Dates</button>
                    </div>

                    <div id="adminScriptOutput" style="margin-top: 10px;">
                        <h4>Generated Script:</h4>
                        <textarea id="adminScriptContent" readonly style="width: 100%; height: 380px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                        <div style="margin-top: 10px; text-align: right;">
                            <button class="btn btn-secondary" onclick="copyAdminScript()">Copy Script</button>
                            <button class="btn btn-secondary" onclick="downloadAdminScript()">Download Script</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal for GoldenSun Tools -->
    <div id="goldenSunModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 95%; margin-top: 120px;">
            <span class="modal-close" onclick="closeGoldenSunModal()">&times;</span>
            <h2>GoldenSun - Master Images</h2>
            <p style="color: #666;">Use this section to manage cloning of master images. Group names create files named &lt;Group&gt;-Master-Images.json.</p>

            <div style="border-bottom: 2px solid #ddd; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-start;">
                <button class="task-tab active" id="goldenSunTabSearch" onclick="showGoldenSunTab('search')">Build Master List</button>
                <button class="task-tab" id="goldenSunTabClone" onclick="showGoldenSunTab('clone')">Clone Master Images</button>
                <button class="task-tab" id="goldenSunTabReport" onclick="showGoldenSunTab('report')">Image Report</button>
            </div>

            <!-- Clone Tab -->
            <div id="goldenSunClonePanel" class="horizon-task-panel active" style="display: block;">
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 15px 0;">
                    <label for="goldenSunFileSelect" style="font-weight: 600;">Master List File:</label>
                    <button class="btn btn-secondary" onclick="openGoldenSunFileDialog()">Load Images</button>
                    <input type="file" id="goldenSunFilePicker" accept=".json" style="display: none;">
                    <span id="goldenSunStatus" style="color: #666;">Load a Master Images JSON to begin.</span>
                </div>

            <div id="goldenSunImagesSection" style="margin: 20px 0; display: none;">
                <div style="margin-bottom: 10px;">
                <button class="btn btn-sm" onclick="goldenSunSelectAll()">Select All</button>
                <button class="btn btn-sm" onclick="goldenSunDeselectAll()">Deselect All</button>
                </div>
                <div id="goldenSunImagesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f9fa;">
                    <p>Loading images...</p>
                </div>
            </div>

            <div id="goldenSunCloneSection" style="margin: 20px 0; display: none;">
                <h4 style="margin-bottom: 15px;">Clone Destination Configuration</h4>

                        <!-- Push Windows Update Toggle -->
                        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 240px;">
                                    <h5 style="margin: 0 0 5px 0; font-weight: bold;">Push Windows Update (On / Off)</h5>
                                    <p style="margin: 0; color: #666; font-size: 14px;">Default ON. When ON, cloned VMs power on and run mspatch.ps1 to install updates.</p>
                                </div>
                                <label class="toggle-switch" aria-label="GoldenSun Push Windows Update">
                                    <input type="checkbox" id="goldenSunPushWindowsUpdateToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                <!-- VMware Folder Operations Toggle -->
                <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 240px;">
                            <h5 style="margin: 0 0 5px 0; font-weight: bold;">Change VMware Folders (On / Off)</h5>
                            <p style="margin: 0; color: #666; font-size: 14px;">Default OFF. When OFF, no VMware folder changes are made.</p>
                        </div>
                        <label class="toggle-switch" aria-label="GoldenSun Change VMware Folders">
                            <input type="checkbox" id="goldenSunVmwareToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div id="goldenSunVmwareSection" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label for="goldenSunDestinationFolder" style="display: block; margin-bottom: 6px; font-weight: bold;">VMware Destination Folder:</label>
                        <input type="text" id="goldenSunDestinationFolder" placeholder="/vm/prod/goldensun" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: bold;">Source VM Move Options:</label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="goldenSunMoveSource">
                            Move source VMs to folder after cloning
                        </label>
                        <input type="text" id="goldenSunSourceFolder" placeholder="/vm/archive/goldensun" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button class="btn btn-primary" onclick="generateGoldenSunCloneScript()">Create Script</button>
                </div>
            </div>

            <div id="goldenSunScriptOutput" style="display: none; margin-top: 20px;">
                <h4>Generated Script:</h4>
                <textarea id="goldenSunScriptContent" readonly style="width: 100%; height: 320px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="copyGoldenSunScript()">Copy Script</button>
                    <button class="btn btn-secondary" onclick="downloadGoldenSunScript()">Download Script</button>
                </div>
            </div>
            </div>

            <!-- Search / Build Tab -->
            <div id="goldenSunSearchPanel" class="horizon-task-panel" style="display: none;">
                <h3>Build Master Image List</h3>
                <p style="color: #666;"></p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div>
                        <label for="goldenSunSearchVCenter" style="display: block; font-weight: 600; margin-bottom: 6px;">vCenter Server</label>
                        <input type="text" id="goldenSunSearchVCenter" placeholder="vcenter.domain.local" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Script prompts for credentials if not connected.</small>
                    </div>
                    <div>
                        <label for="goldenSunSearchGroup" style="display: block; font-weight: 600; margin-bottom: 6px;">Group Name</label>
                        <input type="text" id="goldenSunSearchGroup" placeholder="e.g., ProdApps" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666;">Used in output file name: &lt;Group&gt;-Master-Images.json</small>
                    </div>
                </div>

                <div style="margin: 15px 0;">
                    <label for="goldenSunSearchVMs" style="display: block; font-weight: 600; margin-bottom: 6px;">Master VM Names (semicolon delimited)</label>
                    <textarea id="goldenSunSearchVMs" placeholder="vm1; vm2; vm3" style="width: 100%; height: 110px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>

                <div style="text-align: right; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="generateGoldenSunSearchScript()">Generate Search Script</button>
                </div>

                <div id="goldenSunSearchScriptOutput" style="display: none; margin-top: 20px;">
                    <h4>Generated Search Script:</h4>
                    <textarea id="goldenSunSearchScriptContent" readonly style="width: 100%; height: 320px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;"></textarea>
                    <div style="margin-top: 10px; text-align: right;">
                        <button class="btn btn-secondary" onclick="copyGoldenSunSearchScript()">Copy Script</button>
                        <button class="btn btn-secondary" onclick="downloadGoldenSunSearchScript()">Download Script</button>
                    </div>
                </div>
            </div>

            <!-- Image Report Tab -->
            <div id="goldenSunReportPanel" class="horizon-task-panel" style="display: none;">
                <h3>Image Report</h3>
                <p style="color:#666;">Load the master images JSON and view snapshot timestamps. Sorted by name (A-Z) by default.</p>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0;">
                    <button class="btn btn-secondary" onclick="openGoldenSunFileDialog()">Load JSON</button>
                    <span id="goldenSunReportStatus" style="color:#666;"></span>
                    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                        <label style="font-weight:600;">Sort:</label>
                        <button class="btn btn-sm" onclick="setGoldenSunReportSort('name')">Name</button>
                        <button class="btn btn-sm" onclick="setGoldenSunReportSort('date')">Snapshot Date</button>
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0;">
                    <button class="btn btn-primary" onclick="generateGoldenSunReportScript()">Re-run snapshot check (PowerShell)</button>
                </div>
                <div id="goldenSunReportScriptOutput" style="display:none; margin:10px 0;">
                    <h4 style="margin:0 0 6px 0;">Snapshot Re-check Script</h4>
                    <textarea id="goldenSunReportScriptContent" readonly style="width:100%; height:240px; font-family:'Courier New', monospace; font-size:12px; padding:8px; border:1px solid #ddd; border-radius:4px; background:#f8f9fa;"></textarea>
                    <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
                        <button class="btn btn-secondary" onclick="copyGoldenSunReportScript()">Copy</button>
                        <button class="btn btn-secondary" onclick="downloadGoldenSunReportScript()">Download</button>
                    </div>
                </div>
                <div id="goldenSunReportList" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:10px; background:#f8f9fa;"></div>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderBrowserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <h2>📁 Browse VMware Folders</h2>
                <span class="close" onclick="closeFolderBrowserModal()">&times;</span>
            </div>
            <div id="folderBrowserContent">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">Select a VMware folder for VM placement. Common folder structures are shown below:</p>

                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f9fa;">
                        <div class="folder-option" onclick="selectFolder('/vm')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm</strong> - Root VM folder
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/prod')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/prod</strong> - Production VMs
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/prod/windows')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/prod/windows</strong> - Windows production VMs
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/test')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/test</strong> - Test VMs
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/dev')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/dev</strong> - Development VMs
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/archive')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/archive</strong> - Archived VMs
                        </div>
                        <div class="folder-option" onclick="selectFolder('/vm/backup')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/backup</strong> - Backup VMs
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="customFolderPath" style="display: block; margin-bottom: 8px; font-weight: bold;">Or enter custom path:</label>
                    <input type="text" id="customFolderPath" placeholder="/vm/custom/path" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeFolderBrowserModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmCustomFolder()" style="margin-left: 10px;">Use Custom Path</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Folder Browser Modal -->
    <div id="sourceFolderBrowserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <h2>📁 Browse Archive Folders</h2>
                <span class="close" onclick="closeSourceFolderBrowserModal()">&times;</span>
            </div>
            <div id="sourceFolderBrowserContent">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">Select a folder to move source VMs after cloning:</p>

                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f8f9fa;">
                        <div class="folder-option" onclick="selectSourceFolder('/vm/archive')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/archive</strong> - Archive folder
                        </div>
                        <div class="folder-option" onclick="selectSourceFolder('/vm/backup')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/backup</strong> - Backup folder
                        </div>
                        <div class="folder-option" onclick="selectSourceFolder('/vm/retired')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/retired</strong> - Retired VMs
                        </div>
                        <div class="folder-option" onclick="selectSourceFolder('/vm/old')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/old</strong> - Old VMs
                        </div>
                        <div class="folder-option" onclick="selectSourceFolder('/vm/decommissioned')" style="cursor: pointer; padding: 8px; margin: 2px 0; border-radius: 4px; background: white; border: 1px solid #eee;">
                            📁 <strong>/vm/decommissioned</strong> - Decommissioned VMs
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="customSourceFolderPath" style="display: block; margin-bottom: 8px; font-weight: bold;">Or enter custom path:</label>
                    <input type="text" id="customSourceFolderPath" placeholder="/vm/custom/archive" style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeSourceFolderBrowserModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmCustomSourceFolder()" style="margin-left: 10px;">Use Custom Path</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; width: 90%; margin-top: 150px;">
            <span class="modal-close" onclick="closeConfigModal()">&times;</span>
            <h2 style="text-align: center;">
                <img src="/images/lab007-trans.PNG" alt="LAB007 Logo" style="max-height: 60px; margin-bottom: 10px;">
                <br>Configuration
            </h2>
            <div id="configContent">
                <form id="mainConfigForm">
                    <div class="config-section">
                        <h3>Citrix Configuration</h3>
                        <div class="form-group">
                            <label for="configCitrixVersion">Citrix Version:</label>
                            <select id="configCitrixVersion" name="citrixVersion" required>
                                <option value="1912" selected>1912 / 7.x (Snap-ins)</option>
                                <option value="2009">2009</option>
                                <option value="2012">2012</option>
                                <option value="2112">2112</option>
                                <option value="2203">2203</option>
                                <option value="2209">2209</option>
                                <option value="2305">2305</option>
                                <option value="2311">2311</option>
                            </select>
                            <div class="help-text">Select your Citrix environment version</div>
                        </div>

                        <div class="form-group">
                            <label for="configDdcName">Delivery Controller (DDC) Name:</label>
                            <input type="text" id="configDdcName" name="ddcName" value="localhost" required placeholder="localhost or FQDN">
                            <div class="help-text">Enter the DDC hostname or FQDN (e.g., ddc01.domain.com)</div>
                        </div>

                        <div class="form-group">
                            <label for="configUsageDays">Days of Usage Data:</label>
                            <input type="number" id="configUsageDays" name="usageDays" value="30" min="1" max="365" required>
                            <div class="help-text">Number of days to analyze for usage statistics (1-365)</div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="configRunPreReqCheck" name="runPreReqCheck" checked style="width: auto; margin-right: 8px;">
                                Run Pre-requisite Checks
                            </label>
                            <div class="help-text">Check this to run system pre-requisite checks before starting the audit</div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>VMware Configuration</h3>
                        <div class="form-group">
                            <label for="configVCenterServer">vCenter Server:</label>
                            <input type="text" id="configVCenterServer" name="vCenterServer" value="shcvcsacx01v.ccr.cchcs.org" placeholder="vCenter FQDN">
                            <div class="help-text">Enter your vCenter server FQDN for VMware operations</div>
                        </div>

                        <div class="form-group">
                            <label for="configVCenterUsername">vCenter Username:</label>
                            <input type="text" id="configVCenterUsername" name="vCenterUsername" value="" placeholder="username@domain.com">
                            <div class="help-text">Optional: VMware username for vCenter authentication</div>
                        </div>

                        <div class="form-group">
                            <label for="configVCenterPassword">vCenter Password:</label>
                            <input type="password" id="configVCenterPassword" name="vCenterPassword" value="" placeholder="password">
                            <div class="help-text">Optional: VMware password for vCenter authentication</div>
                        </div>

                        <div class="form-group">
                            <label for="configMasterImagePrefix">Master Image Prefix:</label>
                            <input type="text" id="configMasterImagePrefix" name="masterImagePrefix" value="SHC-M-" placeholder="e.g., SHC-M-">
                            <div class="help-text">Prefix used to identify master images (images will be searched using: [Prefix]* pattern)</div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>Audit Components</h3>
                        <div class="audit-components-grid">
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditSiteInfo" name="auditSiteInfo" checked>
                                <div>
                                    <strong>Site Information</strong>
                                    <div class="component-desc">Citrix site details & licensing</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditApplications" name="auditApplications" checked>
                                <div>
                                    <strong>Published Applications</strong>
                                    <div class="component-desc">All published apps</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditDesktops" name="auditDesktops" checked>
                                <div>
                                    <strong>Published Desktops</strong>
                                    <div class="component-desc">All published desktops</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditCatalogs" name="auditCatalogs" checked>
                                <div>
                                    <strong>Machine Catalogs</strong>
                                    <div class="component-desc">Catalog configurations</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditDeliveryGroups" name="auditDeliveryGroups" checked>
                                <div>
                                    <strong>Delivery Groups</strong>
                                    <div class="component-desc">Delivery group settings</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditUsageStats" name="auditUsageStats" checked>
                                <div>
                                    <strong>Usage Statistics</strong>
                                    <div class="component-desc">Usage data & sessions</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditPolicies" name="auditPolicies" checked>
                                <div>
                                    <strong>Citrix Policies</strong>
                                    <div class="component-desc">Policy configurations</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditRoles" name="auditRoles" checked>
                                <div>
                                    <strong>Management Roles</strong>
                                    <div class="component-desc">Admin roles & permissions</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditVMwareSpecs" name="auditVMwareSpecs">
                                <div>
                                    <strong>VMware Server Specs</strong>
                                    <div class="component-desc">VMware VM specifications</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditVMwareFolders" name="auditVMwareFolders">
                                <div>
                                    <strong>VMware Folder Structure</strong>
                                    <div class="component-desc">VMware VM folder hierarchy</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditServers" name="auditServers" checked>
                                <div>
                                    <strong>Server Information</strong>
                                    <div class="component-desc">Citrix server details</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditDirectorOData" name="auditDirectorOData" checked>
                                <div>
                                    <strong>Director OData</strong>
                                    <div class="component-desc">Monitoring data from Director</div>
                                </div>
                            </label>
                            <label class="audit-component">
                                <input type="checkbox" id="configAuditAppIcons" name="auditAppIcons" checked>
                                <div>
                                    <strong>App Icons</strong>
                                    <div class="component-desc">Export Citrix application icons</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-info" id="testConnectionBtn" onclick="testConnection()" style="background: #17a2b8; border-color: #17a2b8;">🔗 Test Connection</button>
                        <button type="submit" class="btn btn-primary" id="saveMainConfigBtn">⬇️ Download Config</button>
                        <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
                    </div>
                </form>

                <div id="configStatusMessage" class="status-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Debug Tools Modal (inline, white theme) -->
    <div id="debugToolsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95%; width: 95%; margin-top: 120px; background: #ffffff; color: #111;">
            <span class="modal-close" onclick="closeDebugToolsModal()">&times;</span>
            <h2 style="color:#111;">Debug Tools</h2>
            <p style="color:#444;">Upload/store Horizon debug bundles or anonymise a log without leaving this page.</p>

            <div style="border-bottom: 2px solid #ddd; margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="task-tab active" id="debugTabUploadBtn" onclick="showDebugToolsTab('upload')" style="color:#111;">Upload &amp; Store</button>
                <button class="task-tab" id="debugTabAnonBtn" onclick="showDebugToolsTab('anon')" style="color:#111;">Anonymise Log</button>
            </div>

            <div id="debugToolsUploadPanel" class="horizon-task-panel active" style="display: block; color:#111;">
                <div style="margin: 12px 0; padding: 14px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;">
                    <p style="margin:0 0 10px 0; color:#333;">Select a ZIP or text log. Files are stored via the existing /citrix/api/upload-debug endpoint.</p>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <button id="debugStorePickBtn" class="btn btn-secondary" style="background:#e5b600; color:#000; border-color:#e5b600;">Choose File</button>
                        <input type="file" id="debugStoreFileModal" accept=".zip,.log,.txt" style="display:none;">
                        <span id="debugStoreStatus" style="color:#555;">No file chosen.</span>
                    </div>
                </div>
            </div>

            <div id="debugToolsAnonPanel" class="horizon-task-panel" style="display: none; color:#111;">
                <div style="margin: 12px 0; padding: 14px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; display:flex; flex-direction:column; gap:12px;">
                    <div>
                        <label for="anonDomainsModal" style="font-weight:600;">Domain Names (comma separated)</label>
                        <input id="anonDomainsModal" type="text" class="input" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; color:#111;">
                        <small style="color:#555;">Matches replaced with DUMMYDOMAIN</small>
                    </div>
                    <div style="display:flex; gap:16px; flex-wrap:wrap;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#111;">
                            <input type="checkbox" id="anonIpModal"> Replace IP addresses with 1.2.3.4
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#111;">
                            <input type="checkbox" id="anonUserModal"> Replace usernames with USERID
                        </label>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <button id="anonPickBtn" class="btn btn-secondary" style="background:#e5b600; color:#000; border-color:#e5b600;">Choose File</button>
                        <input type="file" id="anonFileModal" accept=".txt,.log,.conf,.json,.ini" style="display:none;">
                        <span id="anonStatusModal" style="color:#555;">No file chosen.</span>
                    </div>
                    <p style="color:#444; margin:0;">Downloads an anonymised copy with “_anon” suffix.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <img src="/citrix/images/LAB007-LOGO-TRANS.png" alt="LAB007 Logo" class="footer-logo">
            <p class="footer-text">
                Copyright 2025 - LAB007.AI All rights reserved. See <a href="https://www.lab007.ai" target="_blank">www.lab007.ai</a> for Conditions of use.
            </p>
        </div>
    </footer>

    <script src="dashboard.js"></script>
    <script>
    // UAG modal + parser (lightweight inline to avoid extra page)
    mermaid.initialize({ startOnLoad: false, theme: 'dark' });
    const uagData = { gateways: [], conn: [], dns: [], ad: [], certs: [], external: [] };
    const uagMeta = { uagName: '-', uagIp: '-', csUrl: '-', csThumb: '-', maxBlast: '-' };

    function openUagModal() {
        const modal = document.getElementById('uagModal');
        if (modal) modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    function closeUagModal() {
        const modal = document.getElementById('uagModal');
        if (modal) modal.style.display = 'none';
        document.body.style.overflow = '';
    }
    // expose for inline onclick
    window.openUagModal = openUagModal;
    window.closeUagModal = closeUagModal;
    function showUagTab(tab) {
        const tabs = ['config','debug','diagram'];
        tabs.forEach(t => {
            const panel = document.getElementById(`uag${capitalize(t)}Panel`);
            const tabBtn = document.getElementById(`uagTab${capitalize(t)}`);
            if (panel) panel.style.display = t === tab ? 'block' : 'none';
            if (tabBtn) tabBtn.classList.toggle('active', t === tab);
        });
    }
    function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
    function escapeHtml(str){return (str||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

    // Config handling
    const cfgInput = document.getElementById('uagConfigFile');
    if (cfgInput) {
        cfgInput.addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            setUagStatus('uagConfigStatus', `Reading ${file.name} ...`);
            const text = await file.text();
            parseUagConfig(text);
        });
    }

    function parseUagConfig(text) {
        resetUagData();
        // Try JSON first
        try {
            const obj = JSON.parse(text);
            if (obj.generalSettings || obj.edgeServiceSettingsList) {
                hydrateFromJson(obj);
                renderUag();
                setUagStatus('uagConfigStatus','Config parsed (JSON)');
                return;
            }
        } catch {}
        // Fallback: line parsing
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        lines.forEach(line=>{
            const urls = line.match(/https?:\/\/[^\s"']+/gi) || [];
            urls.forEach(u => {
                if (/gateway|uag/i.test(line)) uagData.gateways.push(u);
                uagData.external.push(u);
            });
            const hosts = (line.match(/\b(?:[A-Za-z0-9-]+\.)+[A-Za-z]{2,}\b/g) || [])
                .concat(line.match(/\b\d{1,3}(?:\.\d{1,3}){3}\b/g) || []);
            if (/gateway|uag/i.test(line)) hosts.forEach(h=>uagData.gateways.push(h));
            if (/connection|conn/i.test(line)) hosts.forEach(h=>uagData.conn.push(h));
            if (/dns|nameserver/i.test(line)) hosts.forEach(h=>uagData.dns.push(h));
            if (/(ad|ldap|entra)/i.test(line)) hosts.forEach(h=>uagData.ad.push(h));
            if (/cert/i.test(line)) hosts.forEach(h=>uagData.certs.push(h));
        });
        renderUag();
        setUagStatus('uagConfigStatus','Config parsed (text)');
    }

    function isUrl(val){ return /^https?:\/\//i.test(val); }
    function isHostOrIp(val){
        if (!val || typeof val !== 'string') return false;
        if (/\s/.test(val)) return false;
        const ip = /^\d{1,3}(\.\d{1,3}){3}$/;
        const host = /^[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
        return ip.test(val) || host.test(val);
    }
    function addVal(arr,val){ if (val) arr.push(val); }
    function hydrateFromJson(obj){
        const gs = obj.generalSettings || {};
        addVal(uagData.gateways, gs.ip0);
        addVal(uagData.gateways, gs.defaultGateway);
        if (gs.ip0) uagMeta.uagIp = gs.ip0;

        const sys = obj.systemSettings || {};
        if (sys.uagName) uagMeta.uagName = sys.uagName;
        (sys.dns || '').split(/\s+/).filter(Boolean).forEach(v=>addVal(uagData.dns, v));
        (sys.dnsSearch || '').split(/\s+/).filter(Boolean).forEach(v=>addVal(uagData.ad, v));
        (sys.allowedHostHeaderValues || '').split(/[, ]+/).filter(Boolean).forEach(v=>addVal(uagData.gateways, v));
        (sys.autoAllowedHostHeaderValues || '').split(/[, ]+/).filter(Boolean).forEach(v=>addVal(uagData.gateways, v));
        addVal(uagData.gateways, sys.uagName);

        const svcList = Array.isArray(obj.edgeServiceSettingsList?.edgeServiceSettingsList)
            ? obj.edgeServiceSettingsList.edgeServiceSettingsList
            : Array.isArray(obj.edgeServiceSettingsList) ? obj.edgeServiceSettingsList : [];
        svcList.forEach(svc=>{
            addVal(uagData.external, svc.blastExternalUrl);
            addVal(uagData.external, svc.tunnelExternalUrl);
            if (svc.proxyDestinationUrl) {
                addVal(uagData.conn, svc.proxyDestinationUrl);
                uagMeta.csUrl = svc.proxyDestinationUrl;
                try {
                    const h = new URL(svc.proxyDestinationUrl).hostname;
                    addVal(uagData.conn, h);
                } catch(_){}
            }
            if (svc.proxyDestinationUrlThumbprints) uagMeta.csThumb = svc.proxyDestinationUrlThumbprints;
            if (svc.maxActiveBlastSessions) uagMeta.maxBlast = svc.maxActiveBlastSessions;
            (svc.originHeaderDetailsList||[]).forEach(o=>{
                if (isUrl(o.origin)) addVal(uagData.conn, o.origin);
                else if (isHostOrIp(o.origin)) addVal(uagData.conn, o.origin);
            });
        });

        const walk = (node, keyHint='')=>{
            if (node == null) return;
            if (Array.isArray(node)) { node.forEach(n=>walk(n,keyHint)); return; }
            if (typeof node === 'object') {
                Object.entries(node).forEach(([k,v])=>{
                    walk(v, k.toLowerCase());
                });
                return;
            }
            if (typeof node === 'string') {
                const val = node.trim();
                if (isUrl(val)) {
                    addVal(uagData.external, val);
                    if (keyHint.includes('gateway')) addVal(uagData.gateways, val);
                    if (keyHint.includes('conn')) addVal(uagData.conn, val);
                    return;
                }
                if (isHostOrIp(val)) {
                    if (keyHint.includes('gateway') || keyHint.includes('uag')) addVal(uagData.gateways, val);
                    else if (keyHint.includes('conn') || keyHint.includes('connection')) addVal(uagData.conn, val);
                    else if (keyHint.includes('dns') || keyHint.includes('nameserver')) addVal(uagData.dns, val);
                    else if (keyHint.includes('ldap') || keyHint.includes('ad') || keyHint.includes('entra')) addVal(uagData.ad, val);
                    else addVal(uagData.external, val);
                    if (keyHint.includes('cert')) addVal(uagData.certs, val);
                }
            }
        };
        walk(obj,'');
    }

    function renderUag(){
        const uniq = arr => Array.from(new Set(arr.filter(Boolean)));
        uagData.gateways = uniq(uagData.gateways);
        uagData.conn = uniq(uagData.conn);
        uagData.dns = uniq(uagData.dns);
        uagData.ad = uniq(uagData.ad);
        uagData.certs = uniq(uagData.certs);
        uagData.external = uniq(uagData.external);

        setChipList('uagListGateway', uagData.gateways);
        setChipList('uagListConn', uagData.conn);
        setChipList('uagListDns', uagData.dns);
        setChipList('uagListAd', uagData.ad);
        setChipList('uagListCerts', uagData.certs);
        document.getElementById('uagStatGateways').textContent = uagData.gateways.length;
        document.getElementById('uagStatConn').textContent = uagData.conn.length;
        document.getElementById('uagStatDns').textContent = uagData.dns.length;
        document.getElementById('uagStatAd').textContent = uagData.ad.length;
        document.getElementById('uagStatCerts').textContent = uagData.certs.length;
        document.getElementById('uagStatExt').textContent = uagData.external.length;
        const metaMap = {
            uagMetaName: uagMeta.uagName || '-',
            uagMetaIp: uagMeta.uagIp || '-',
            uagMetaCsUrl: uagMeta.csUrl || '-',
            uagMetaThumb: uagMeta.csThumb || '-',
            uagMetaBlast: uagMeta.maxBlast || '-'
        };
        Object.entries(metaMap).forEach(([id,val])=>{
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        });
        // Pre-fill manual diagram fields if empty
        setManualIfEmpty('uagManualUag', [uagMeta.uagName]);
        setManualIfEmpty('uagManualUagIp', [uagMeta.uagIp]);
        renderUagDiagram();
    }

    function setChipList(id, arr){
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = arr.length ? arr.map(v=>`<span class="chip">${escapeHtml(v)}</span>`).join('') : '<span style="color:#94a3b8;">None</span>';
    }

    function renderUagDiagram(){
        const container = document.getElementById('uagMermaidGraph');
        const lines = ['flowchart TB'];
        uagData.gateways.forEach((g,i)=> lines.push(`gw${i}([Gateway ${i+1}\\n${escapeMermaid(g)}])`));
        uagData.conn.forEach((c,i)=> lines.push(`cs${i}([Conn ${i+1}\\n${escapeMermaid(c)}])`));
        uagData.dns.forEach((d,i)=> lines.push(`dns${i}([DNS ${i+1}\\n${escapeMermaid(d)}])`));
        uagData.ad.forEach((a,i)=> lines.push(`ad${i}([AD ${i+1}\\n${escapeMermaid(a)}])`));
        uagData.certs.forEach((c,i)=> lines.push(`crt${i}([Cert ${i+1}\\n${escapeMermaid(c)}])`));

        // Build edges
        if (uagData.gateways.length && (uagData.conn.length || uagData.external.length)) {
            uagData.gateways.forEach((_,gi)=>{
                uagData.conn.forEach((_,ci)=> lines.push(`gw${gi} --> cs${ci}`));
                uagData.external.forEach((ext,ei)=>{
                    lines.push(`ext${ei}([External ${ei+1}\\n${escapeMermaid(ext)}])`);
                    lines.push(`ext${ei} --> gw${gi}`);
                });
            });
        }
        if (uagData.conn.length && uagData.dns.length) {
            uagData.conn.forEach((_,ci)=> uagData.dns.forEach((_,di)=> lines.push(`cs${ci} --> dns${di}`)));
        }
        if (uagData.conn.length && uagData.ad.length) {
            uagData.conn.forEach((_,ci)=> uagData.ad.forEach((_,ai)=> lines.push(`cs${ci} --> ad${ai}`)));
        }
        // If no nodes were added, show guidance instead of empty graph
        if (lines.length === 1) {
            if (container) container.innerHTML = `
            <div style="padding:12px; color:#94a3b8; display:flex; align-items:center; gap:12px;">
                <svg width="90" height="70" viewBox="0 0 160 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="10" y="25" width="140" height="70" rx="10" fill="#0f172a" stroke="#22d3ee" stroke-width="4"/>
                    <rect x="30" y="45" width="30" height="30" rx="4" fill="#22d3ee" opacity="0.2" stroke="#22d3ee" stroke-width="3"/>
                    <rect x="100" y="45" width="30" height="30" rx="4" fill="#22d3ee" opacity="0.2" stroke="#22d3ee" stroke-width="3"/>
                    <rect x="67" y="35" width="26" height="50" rx="6" fill="#0f172a" stroke="#22d3ee" stroke-width="3"/>
                    <circle cx="80" cy="60" r="6" fill="#22d3ee"/>
                    <path d="M80 46 L80 52" stroke="#22d3ee" stroke-width="3" stroke-linecap="round"/>
                    <path d="M80 68 L80 74" stroke="#22d3ee" stroke-width="3" stroke-linecap="round"/>
                    <path d="M55 60 H67" stroke="#22d3ee" stroke-width="3" stroke-linecap="round"/>
                    <path d="M93 60 H105" stroke="#22d3ee" stroke-width="3" stroke-linecap="round"/>
                </svg>
                <div>
                    <div style="font-weight:700; color:#e2e8f0;">Gateway topology</div>
                    <div>Load a config with at least one gateway or external URL to draw the diagram.</div>
                </div>
            </div>`;
            return;
        }
        const graph = lines.join('\n');
        if (!container) return;
        try {
            mermaid.render('uagGraphSvg', graph, (svg)=>{ container.innerHTML = svg; });
        } catch (err) {
            console.error('Mermaid render failed', err);
            container.innerHTML = '<div style="padding:12px; color:#f87171;">Could not render diagram. Check that the config has gateways / external URLs / connection servers.</div>';
        }
    }

    async function renderManualDiagram(){
        const status = document.getElementById('uagManualStatus');
        const tgt = document.getElementById('uagManualMermaid');
        const extDns = (document.getElementById('uagManualExternalDns')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const dmzLb = (document.getElementById('uagManualDmzLb')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const uag = (document.getElementById('uagManualUag')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const uagIp = (document.getElementById('uagManualUagIp')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const intLb = (document.getElementById('uagManualInternalLb')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const conn = (document.getElementById('uagManualConn')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const connIp = (document.getElementById('uagManualConnIp')?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        if (status) status.innerHTML = '<span class="spinner-eye"></span> Building diagram...';
        if (tgt) tgt.innerHTML = 'Generating...';
        console.log('[UAG Diagram] payload', { extDns, dmzLb, uag, uagIp, intLb, conn, connIp });
        try{
            const res = await fetch('/api/uag/diagram-ai', {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({
                    externalDns: extDns,
                    dmzLoadBalancers: dmzLb,
                    uagNames: uag,
                    uagIps: uagIp,
                    internalLb: intLb,
                    connServers: conn,
                    connIps: connIp
                })
            });
            const data = await res.json().catch(()=> ({}));
            console.log('[UAG Diagram] response', data);
            if (!res.ok) throw new Error(data?.error || 'Diagram generation failed');
            if (!data.svg || !data.svg.startsWith('<?xml')) throw new Error('Invalid SVG returned');
            if (tgt) {
                tgt.innerHTML = data.svg;
            }
            if (status) status.textContent = `Diagram generated (${extDns.length} DNS, ${dmzLb.length} DMZ LB, ${uag.length} UAG, ${conn.length} Conn).`;
        }catch(err){
            console.error('AI diagram render failed', err);
            if (status) status.textContent = err.message || 'Failed to generate diagram.';
            if (tgt) tgt.innerHTML = '<div style="color:#f87171;">Diagram error</div>';
        }
    }
    function escapeMermaid(s){
        return (s||'')
            .replace(/[\[\]\(\)\{\}]/g,'')
            .replace(/[^a-zA-Z0-9 .:\/_\-]/g,''); // strip characters that break mermaid labels
    }
    function resetUagData(){
        uagData.gateways=[]; uagData.conn=[]; uagData.dns=[]; uagData.ad=[]; uagData.certs=[]; uagData.external=[];
    }
    function setUagStatus(id,msg){ const el=document.getElementById(id); if(el) el.innerHTML = msg; }
    function setManualIfEmpty(id, values){
        const el = document.getElementById(id);
        if (!el || !values || !values.length) return;
        if (!el.value || !el.value.trim()) {
            el.value = values.filter(Boolean).join(', ');
        }
    }
    async function handleCsBundleUpload(e){
        const file = e.target.files?.[0];
        if (!file) return;
        await renderCsBundleFromFile(file);
    }
    function renderCsBundle(){
        const wrap = document.getElementById('csBundleResults');
        const summary = document.getElementById('csBundleSummary');
        if (summary) {
            summary.innerHTML = Object.entries(csBundleGroups).map(([k,v])=> `<div class="card" style="padding:8px 10px; background:#11182a; color:#e5e8f0; border-radius:8px; border:1px solid rgba(255,255,255,0.08); font-size:13px;">${k.toUpperCase()} <span style="color:#e5b600;font-weight:700;">${v.length}</span></div>`).join('');
        }
        if (!wrap) return;
        let html = '';
        Object.entries(csBundleGroups).forEach(([cat, files], idx)=>{
            html += `<details class="log-group" open>
                        <summary style="cursor:pointer; font-weight:700; color:#e5b600; padding:6px 4px;">${cat.toUpperCase()} (${files.length})</summary>
                        <div>`;
            files.sort().forEach((f,i)=>{
                const id = `csfile-${cat}-${i}`;
                html += `<div class="log-entry" style="margin-bottom:6px;">
                            <div class="log-head" onclick="loadCsFile('${cat}','${f}','${id}')">
                                <span>${escapeHtml(f)}</span>
                                <span class="log-toggle">+</span>
                            </div>
                            <div class="log-body" id="${id}" style="display:none;"></div>
                         </div>`;
            });
            html += `</div></details>`;
        });
        wrap.innerHTML = html || '<div style="color:#94a3b8;">No files loaded.</div>';
    }
    async function loadCsFile(cat, filename, targetId){
        const body = document.getElementById(targetId);
        const toggle = body?.previousElementSibling?.querySelector('.log-toggle');
        if (!body) return;
        const zipInput = document.getElementById('csBundleFile');
        const file = zipInput?.files?.[0];
        if (!file) return;
        const open = body.style.display === 'block';
        if (open){
            body.style.display = 'none';
            if (toggle) toggle.textContent = '+';
            return;
        }
        body.style.display = 'block';
        body.innerHTML = '<span class="spinner-eye"></span> Loading...';
        if (toggle) toggle.textContent = '−';
        try{
            const buf = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(buf);
            const entry = zip.file(filename);
            if (!entry) throw new Error('File missing in zip');
            const text = await entry.async('string');
            body.innerHTML = `<pre style="white-space:pre-wrap; font-size:12px; color:#cbd5e1; margin:0;">${escapeHtml(text)}</pre>`;
        }catch(err){
            console.error('CS file load error', err);
            body.innerHTML = `<div style="color:#f87171;">Error loading file: ${escapeHtml(err.message||'unknown')}</div>`;
        }
    }
    async function renderCsBundleFromFile(file){
        const status = document.getElementById('csBundleStatus');
        const results = document.getElementById('csBundleResults');
        if (!status && !results) {
            console.warn('CS bundle UI not present; open UAG > Debug/Logs to view.');
            return;
        }
        if (status) status.innerHTML = `<span class="spinner-eye"></span> Reading ${escapeHtml(file.name)} ...`;
        csBundleGroups = {};
        try{
            if (typeof JSZip === 'undefined') throw new Error('JSZip missing');
            const buf = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(buf);
            const names = Object.keys(zip.files||{});
            const cats = {
                debug: /debug-.*\.log/i,
                broker: /broker-.*\.log/i,
                security: /security-.*\.log/i,
                pcoip: /pcoip_server-.*\.log/i,
                messages: /(messages|syslog|event|evt|evtx)/i
            };
            names.forEach(n=>{
                if (zip.files[n].dir) return;
                let cat = 'other';
                if (cats.debug.test(n)) cat='debug';
                else if (cats.broker.test(n)) cat='broker';
                else if (cats.security.test(n)) cat='security';
                else if (cats.pcoip.test(n)) cat='pcoip';
                else if (cats.messages.test(n)) cat='messages';
                if (!csBundleGroups[cat]) csBundleGroups[cat]=[];
                csBundleGroups[cat].push(n);
            });
            renderCsBundle();
            if (status) status.textContent = `Loaded ${names.length} file(s). See panels below.`;
        }catch(err){
            console.error('CS bundle error', err);
            if (status) status.textContent = 'Failed to read bundle: ' + (err.message || err);
            if (results) results.innerHTML = `<div style="color:#f87171;">${escapeHtml(err.message||'Bundle parse failed')}</div>`;
        }
    }
    window.renderCsBundleFromFile = renderCsBundleFromFile;
    function handleCsAnyUpload(e){
        const file = e.target.files?.[0];
        if (!file) return;
        const status = document.getElementById('csBundleStatus');
        if (status) status.textContent = `Received file: ${file.name} (${file.size} bytes)`;
    }

    // Debug / logs
    const logInput = document.getElementById('uagLogFile');
    const logSearchBtn = document.getElementById('uagLogSearchBtn');
    const logPrevBtn = document.getElementById('uagLogPrevBtn');
    const logNextBtn = document.getElementById('uagLogNextBtn');
    const aiBtn = document.getElementById('uagAiBtn');
    const logLevelSel = document.getElementById('uagLogLevel');
    if (logInput) {
        logInput.addEventListener('change', handleLogZip);
    }
    if (logSearchBtn) {
        logSearchBtn.addEventListener('click', () => filterLogs());
    }
    if (logLevelSel) {
        logLevelSel.addEventListener('change', () => {
            uagLogLevel = logLevelSel.value || 'all';
            filterLogs();
        });
    }
    if (aiBtn) {
        aiBtn.addEventListener('click', analyzeLogAi);
    }
    const csBundleFile = document.getElementById('csBundleFile');
    const csAnyFile = document.getElementById('csAnyFile');
    if (csBundleFile) csBundleFile.addEventListener('change', handleCsBundleUpload);
    if (csAnyFile) csAnyFile.addEventListener('change', handleCsAnyUpload);
    let uagLogEntries = [];
    let uagLogMatches = [];
    let uagLogMatchIndex = -1;
    let aiRunning = false;
    let uagLogLevel = 'all';
    // CS bundle
    let csBundleGroups = {};
    const uagLogReverse = true;
    async function handleLogZip(e){
        const file = e.target.files?.[0];
        if (!file) return;
        setUagStatus('uagLogStatus', `<span class="spinner-eye"></span> Loading ${escapeHtml(file.name)} ...`);
        try{
            const buf = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(buf);
            const entries = [];
            await Promise.all(Object.keys(zip.files).map(async (k)=>{
                if (zip.files[k].dir) return;
                const txt = await zip.files[k].async('text');
                entries.push({ name:k, text:txt });
            }));
            uagLogEntries = entries;
            setUagStatus('uagLogStatus', `Loaded ${entries.length} file(s).`);
            renderLogResults(entries, (document.getElementById('uagLogSearch')?.value || '').trim());
        }catch(err){
            console.error(err);
            setUagStatus('uagLogStatus', 'Failed to read zip.');
        }
    }
    function filterLogs(){
        const q = (document.getElementById('uagLogSearch')?.value || '').trim();
        renderLogResults(uagLogEntries, q);
    }
    if (logPrevBtn) logPrevBtn.addEventListener('click', () => gotoLogMatch(-1));
    if (logNextBtn) logNextBtn.addEventListener('click', () => gotoLogMatch(1));
    function toggleLogEntry(idx){
        const entry = document.querySelector(`.log-entry[data-idx="${idx}"]`);
        if (!entry) return;
        const body = entry.querySelector('.log-body');
        const icon = entry.querySelector('.log-toggle');
        const open = body.style.display === 'block';
        if (open) {
            body.style.display = 'none';
            if (icon) icon.textContent = '+';
            return;
        }
        // show spinner while expanding large content
        const spinner = document.createElement('div');
        spinner.innerHTML = '<span class="spinner-eye"></span> Loading...';
        spinner.style.color = '#94a3b8';
        body.innerHTML = '';
        body.appendChild(spinner);
        body.style.display = 'block';
        setTimeout(()=> {
            const pre = entry.querySelector('pre');
            if (pre) {
                // already populated
            }
            if (icon) icon.textContent = '−';
            if (body.contains(spinner)) body.removeChild(spinner);
        }, 10); // allow repaint
    }

    function highlightText(text, query){
        if (!query) return escapeHtml(text);
        const escQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(escQ, 'gi');
        return escapeHtml(text).replace(re, (m)=>`<span class="log-match">${m}</span>`);
    }
    function gotoLogMatch(step){
        if (!uagLogMatches.length) return;
        uagLogMatchIndex = (uagLogMatchIndex + step + uagLogMatches.length) % uagLogMatches.length;
        uagLogMatches.forEach((el,i)=> el.classList.toggle('active', i === uagLogMatchIndex));
        const target = uagLogMatches[uagLogMatchIndex];
        if (target) {
            const entry = target.closest('.log-entry');
            if (entry) {
                const body = entry.querySelector('.log-body');
                const icon = entry.querySelector('.log-toggle');
                if (body) body.style.display = 'block';
                if (icon) icon.textContent = '−';
            }
            target.scrollIntoView({ behavior:'smooth', block:'center' });
        }
        const countEl = document.getElementById('uagLogCount');
        if (countEl) countEl.textContent = uagLogMatches.length ? `${uagLogMatchIndex+1}/${uagLogMatches.length}` : '0';
    }

    function getLogGroup(name){
        if (!name) return 'Other';
        const idx = name.indexOf('/');
        return idx > 0 ? name.slice(0, idx) : 'Other';
    }
    function toggleLogGroup(id){
        const body = document.querySelector(`.log-group[data-group="${id}"] .log-group-body`);
        const icon = document.querySelector(`.log-group[data-group="${id}"] .log-group-toggle`);
        if (!body) return;
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        if (icon) icon.textContent = open ? '+' : '−';
    }

    function renderLogResults(list, query = ''){
        const wrap = document.getElementById('uagLogResults');
        if (!wrap) return;
        if (!list.length){ wrap.innerHTML = '<div style="color:#94a3b8;">No entries</div>'; return;}
        const qLower = query.toLowerCase();
        const priorityNames = [
            'esmanager.log','horizon.log','admin.log','audit.log','reverseproxy.log',
            'authbroker.log','wsbroker.log','blastgateway.log','pcoipgateway.log','system.log'
        ];
        const priorityEntries = [];
        const remaining = [];
        list.forEach((entry,i)=>{
            const n = (entry.name||'').toLowerCase();
            const isPriority = priorityNames.some(p=> n.endsWith(p));
            if (isPriority) priorityEntries.push({entry, idx:i}); else remaining.push({entry, idx:i});
        });
        // group by top-level prefix before '/'
        const groups = [];
        const grouped = {};
        remaining.forEach(({entry, idx}) => {
            const g = getLogGroup(entry.name);
            if (!grouped[g]) { grouped[g] = []; groups.push(g); }
            grouped[g].push({ entry, idx });
        });
        // Sort the "Other" group alphabetically by filename for easier scan
        if (grouped['Other']) {
            grouped['Other'].sort((a,b)=> (a.entry.name||'').localeCompare(b.entry.name||''));
        }
        let html = '';
        if (priorityEntries.length){
            const hasMatch = query ? priorityEntries.some(({entry}) => (entry.text||'').toLowerCase().includes(qLower)) : false;
            const bodyDisplay = hasMatch && query ? 'block' : 'none';
            const toggleSymbol = bodyDisplay === 'block' ? '−' : '+';
            html += `
            <div class="log-group" data-group="priority" style="border:1px solid rgba(255,255,255,0.12); border-radius:10px; margin-bottom:10px; background:#0c1326;">
                <div class="log-head" style="font-size:15px;" onclick="toggleLogGroup('priority')">
                    <span>Top Logs <span style="color:#94a3b8;font-weight:500;">(${priorityEntries.length})</span></span>
                    <span class="log-group-toggle">${toggleSymbol}</span>
                </div>
                <div class="log-group-body" style="display:${bodyDisplay}; padding:6px 8px; border-top:1px solid rgba(255,255,255,0.08);">
            `;
            priorityEntries.forEach(({entry, idx})=>{
                let snippet = entry.text || '';
                const lines = snippet.split(/\r?\n/);
                const levelRegex = (uagLogLevel && uagLogLevel !== 'all') ? new RegExp(`\\[${uagLogLevel}\\]`,'i') : null;
                const filtered = levelRegex ? lines.filter(l=> levelRegex.test(l)) : lines;
                if (uagLogReverse) filtered.reverse();
                snippet = filtered.join('\n');
                const hasMatchEntry = qLower ? snippet.toLowerCase().includes(qLower) : false;
                const rendered = highlightText(snippet, query);
                const entryDisplay = hasMatchEntry && query ? 'block' : 'none';
                const toggleSymbolEntry = entryDisplay === 'block' ? '−' : '+';
                html += `
                    <div class="log-entry" data-idx="${idx}" style="margin-bottom:6px;">
                        <div class="log-head" onclick="toggleLogEntry(${idx})">
                            <span>${escapeHtml(entry.name)}</span>
                            <span class="log-toggle">${toggleSymbolEntry}</span>
                        </div>
                        <div class="log-body" style="display:${entryDisplay};">
                            <pre>${rendered}</pre>
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
        }
        groups.forEach((g, gi) => {
            const items = grouped[g];
            const hasMatchInGroup = query ? items.some(({entry}) => (entry.text||'').toLowerCase().includes(qLower)) : false;
            const bodyDisplay = hasMatchInGroup && query ? 'block' : 'none';
            const toggleSymbol = bodyDisplay === 'block' ? '−' : '+';
            html += `
            <div class="log-group" data-group="${gi}" style="border:1px solid rgba(255,255,255,0.12); border-radius:10px; margin-bottom:10px; background:#0c1326;">
                <div class="log-head" style="font-size:15px;" onclick="toggleLogGroup(${gi})">
                    <span>${escapeHtml(g)} <span style="color:#94a3b8;font-weight:500;">(${items.length})</span></span>
                    <span class="log-group-toggle">${toggleSymbol}</span>
                </div>
                <div class="log-group-body" style="display:${bodyDisplay}; padding:6px 8px; border-top:1px solid rgba(255,255,255,0.08);">
            `;
            items.forEach(({entry, idx}) => {
                let snippet = entry.text || '';
                const lines = snippet.split(/\r?\n/);
                const levelRegex = (uagLogLevel && uagLogLevel !== 'all') ? new RegExp(`\\[${uagLogLevel}\\]`,'i') : null;
                const filtered = levelRegex ? lines.filter(l=> levelRegex.test(l)) : lines;
                if (uagLogReverse) filtered.reverse();
                snippet = filtered.join('\n');
                const hasMatch = qLower ? snippet.toLowerCase().includes(qLower) : false;
                const rendered = highlightText(snippet, query);
                const entryDisplay = hasMatch && query ? 'block' : 'none';
                const toggleSymbolEntry = entryDisplay === 'block' ? '−' : '+';
                html += `
                    <div class="log-entry" data-idx="${idx}" style="margin-bottom:6px;">
                        <div class="log-head" onclick="toggleLogEntry(${idx})">
                            <span>${escapeHtml(entry.name)}</span>
                            <span class="log-toggle">${toggleSymbolEntry}</span>
                        </div>
                        <div class="log-body" style="display:${entryDisplay};">
                            <pre>${rendered}</pre>
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;
        });
        wrap.innerHTML = html;
        uagLogMatches = Array.from(wrap.querySelectorAll('.log-match'));
        if (uagLogMatches.length) {
            uagLogMatchIndex = 0;
            uagLogMatches[0].classList.add('active');
            const entry = uagLogMatches[0].closest('.log-entry');
            if (entry) {
                const body = entry.querySelector('.log-body');
                const icon = entry.querySelector('.log-toggle');
                if (body) body.style.display = 'block';
                if (icon) icon.textContent = '−';
            }
            uagLogMatches[0].scrollIntoView({ behavior:'smooth', block:'center' });
        } else {
            uagLogMatchIndex = -1;
        }
        const countEl = document.getElementById('uagLogCount');
        if (countEl) countEl.textContent = uagLogMatches.length ? `${uagLogMatchIndex+1}/${uagLogMatches.length}` : '0';

    }

    async function analyzeLogAi(){
        if (aiRunning) return;
        const text = (document.getElementById('uagAiInput')?.value || '').trim();
        const statusEl = document.getElementById('uagAiStatus');
        const resultEl = document.getElementById('uagAiResult');
        if (!text) {
            if (statusEl) statusEl.textContent = 'Paste an error snippet first.';
            return;
        }
        aiRunning = true;
        if (statusEl) statusEl.innerHTML = '<span class="spinner-eye"></span> Sending to AI...';
        if (resultEl) { resultEl.style.display='none'; resultEl.textContent=''; }
        try{
            const res = await fetch('/api/uag/ai-analyze', {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ text })
            });
            const data = await res.json().catch(()=> ({}));
            if (!res.ok) throw new Error(data?.error || 'AI analyze failed');
            if (statusEl) statusEl.textContent = 'Analysis complete';
            if (resultEl) {
                resultEl.style.display='block';
                resultEl.innerHTML = data.result ? data.result : 'No response.';
            }
        }catch(err){
            console.error('AI analyze error', err);
            if (statusEl) statusEl.textContent = err.message || 'Failed to analyze';
        }finally{
            aiRunning = false;
        }
    }
    </script>
</body>
</html>




