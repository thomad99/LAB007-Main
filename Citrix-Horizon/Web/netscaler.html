<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetScaler Config Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #e8e9ea;
            color: #111;
        }
        header {
            background: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 50%, #2c2c2c 100%),
                        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
            background-size: 100% 100%, 100% 100%, 100% 100%;
            padding: 15px 20px 15px 10px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            min-height: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1500;
            overflow: hidden;
        }
        .header-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 30px;
            padding-left: 0;
        }
        .header-content .logo {
            margin-right: 20px;
        }
        .header-title {
            margin-left: auto;
            color: #fff;
        }
        .header-title .header-subtitle {
            margin: 0;
            color: #dcdcdc;
        }
        .header-title-main {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #fff;
        }
        .header-title-sub {
            font-size: 14px;
            color: #dcdcdc;
        }
        .refresh-controls {
            z-index: 9999;
            position: relative;
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            padding: 0 4px;
            font-size: 12px;
            overflow-x: auto;
        }
        .refresh-controls .column {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 200px;
            align-items: stretch;
        }
        .group-label {
            text-align: center;
            color: #dcdcdc;
            letter-spacing: 2px;
            font-weight: 600;
        }
        .btn-group {
            border: 2px solid #dcdcdc;
            border-radius: 10px;
            padding: 4px;
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.04);
            overflow-x:auto;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #e5b600;
            border: 1px solid #e5b600;
            color: #000;
            font-weight: 700;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            text-decoration: none;
            font-size: 12px;
            min-height: 38px;
        }
        .btn:hover { background: #f2cb2f; transform: translateY(-1px); }
        .btn-primary { background: #e5b600; border-color: #e5b600; color: #000; }
        .btn-secondary { background: #e5b600; border-color: #e5b600; color: #000; }
        .btn-teal { background: #17a2b8; border-color: #17a2b8; color: #fff; }
        .btn-green { background: linear-gradient(135deg,#1f8e3d,#32a852); border-color:#1f8e3d; color:#fff; }
        .container {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 16px 40px;
        }
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 6px 16px rgba(17, 24, 39, 0.08);
        }
        .card h2 {
            margin: 0 0 6px 0;
            font-size: 18px;
            color: #0f172a;
        }
        .card p {
            margin: 0 0 10px 0;
            color: #4b5563;
            font-size: 14px;
        }
        input[type="file"] {
            padding: 10px;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            background: #fff;
            color: #111;
            width: 100%;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }
        .stat {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
        }
        .stat-title { color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { color: #111827; font-weight: 700; font-size: 20px; }
        #status {
            margin-top: 8px;
            color: #b45309;
            font-size: 14px;
        }
        #mermaidContainerLB, #mermaidContainerVPN, #mermaidContainerSvc {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            overflow-x: auto;
        }
        #mermaidGraphLB, #mermaidGraphVPN, #mermaidGraphSvc {
            min-height: 240px;
        }
        pre {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            color: #111;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/citrix/images/LAB007-LOGO-GOLD.png" alt="LAB007 Logo" class="logo" style="opacity: 1; height:48px; width:auto;">
            <div class="header-title">
                <p class="header-subtitle" style="margin: 0;">
                    <span class="header-title-main">Citrix2Horizon</span><br>
                    <span class="header-title-sub">Dashboard</span>
                </p>
            </div>
        </div>
        <div class="refresh-controls">
            <div class="column" style="flex: 1.5 1 0; min-width:220px;">
                <div class="group-label">Discover</div>
                <div class="btn-group">
                    <a href="/citrix/api/download-audit-files" class="btn btn-secondary" style="text-decoration: none;">Download Tools</a>
                    <a href="/citrix/index.html" class="btn btn-primary">Load Audit</a>
                    <a href="/citrix/netscaler.html" class="btn btn-secondary" style="background:#0ea5e9; border-color:#0ea5e9; color:#fff;">NetScaler Config</a>
                    <a href="/citrix/index.html#configModal" class="btn btn-secondary">Config</a>
                </div>
            </div>
            <div class="column" style="flex: 0.7 1 0; min-width:120px;">
                <div class="group-label">Build</div>
                <div class="btn-group" style="padding:4px;">
                    <a href="/citrix/todo.html" class="btn btn-teal">Build</a>
                </div>
            </div>
            <div class="column" style="flex: 1.2 1 0; min-width:200px;">
                <div class="group-label">Manage</div>
                <div class="btn-group" style="padding:6px;">
                    <a href="/citrix/index.html#goldenSunModal" class="btn btn-green">GoldenSun</a>
                    <a href="/citrix/index.html#horizonTasksModal" class="btn btn-secondary">HZ Tasks</a>
                    <a href="/citrix/index.html#uagModal" class="btn btn-secondary">UAG</a>
                    <a href="/citrix/index.html#debugToolsModal" class="btn btn-secondary">Upload Debugs</a>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="card">
            <h2>Upload ns.conf</h2>
            <p>Drop a NetScaler <code>ns.conf</code> file to get a quick overview and a generated diagram of vServers and services.</p>
            <input type="file" id="nsFile" accept=".conf,.txt,.tgz,.tar.gz,.tar">
            <div id="status"></div>
        </div>

        <div class="card">
            <h2>Summary</h2>
            <div class="grid" id="summaryGrid">
                <div class="stat"><div class="stat-title">LB vServers</div><div class="stat-value" id="lbCount">0</div></div>
                <div class="stat"><div class="stat-title">Services</div><div class="stat-value" id="svcCount">0</div></div>
                <div class="stat"><div class="stat-title">Gateways (VPN)</div><div class="stat-value" id="vpnCount">0</div></div>
                <div class="stat"><div class="stat-title">Cert Keys</div><div class="stat-value" id="certCount">0</div></div>
                <div class="stat"><div class="stat-title">DNS Servers</div><div class="stat-value" id="dnsCount">0</div></div>
                <div class="stat"><div class="stat-title">LDAP/AD Actions</div><div class="stat-value" id="ldapCount">0</div></div>
            </div>
        </div>

        <div class="grid" id="detailCards" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:12px;">
            <div class="card"><h2>Load Balance vServers</h2><div id="lbList" class="list"></div></div>
            <div class="card"><h2>Services</h2><div id="svcList" class="list"></div></div>
            <div class="card"><h2>LB Bindings</h2><div id="bindList" class="list"></div></div>
            <div class="card"><h2>VPN vServers</h2><div id="vpnList" class="list"></div></div>
            <div class="card"><h2>Cert Keys</h2><div id="certList" class="list"></div></div>
            <div class="card"><h2>DNS Servers</h2><div id="dnsList" class="list"></div></div>
            <div class="card"><h2>LDAP/AD Actions</h2><div id="ldapList" class="list"></div></div>
            <div class="card"><h2>Servers</h2><div id="serverList" class="list"></div></div>
        </div>

        <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:12px;">
            <div class="card">
                <h2>LB → Services</h2>
                <p style="margin-bottom:8px;">Load balancer vServers linked to bound services.</p>
                <div id="mermaidContainerLB">
                    <div id="mermaidGraphLB"></div>
                </div>
            </div>
            <div class="card">
                <h2>VPN vServers</h2>
                <p style="margin-bottom:8px;">Gateway endpoints.</p>
                <div id="mermaidContainerVPN">
                    <div id="mermaidGraphVPN"></div>
                </div>
            </div>
            <div class="card">
                <h2>Services by Backend</h2>
                <p style="margin-bottom:8px;">Services grouped by backend IP.</p>
                <div id="mermaidContainerSvc">
                    <div id="mermaidGraphSvc"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    mermaid.initialize({ startOnLoad: false, securityLevel: 'loose', theme: 'neutral' });

    const nsFile = document.getElementById('nsFile');
    nsFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            setStatus('Reading file...');
            const name = (file.name || '').toLowerCase();
            let text = '';

            if (name.endsWith('.conf') || name.endsWith('.txt')) {
                text = await file.text();
            } else if (name.endsWith('.tgz') || name.endsWith('.tar.gz') || name.endsWith('.tar')) {
                const buffer = await file.arrayBuffer();
                let tarBytes = new Uint8Array(buffer);
                if (!name.endsWith('.tar')) {
                    setStatus('Decompressing tgz...');
                    tarBytes = pako.ungzip(tarBytes);
                }
                setStatus('Extracting ns.conf from archive...');
                const confBytes = extractFileFromTar(tarBytes, 'ns.conf');
                if (!confBytes) throw new Error('ns.conf not found in archive');
                text = new TextDecoder().decode(confBytes);
            } else {
                throw new Error('Unsupported file type. Please use ns.conf or tgz/tar.gz');
            }

            setStatus('Parsing config...');
            const parsed = parseNsConf(text);
            renderSummary(parsed);
            renderDetails(parsed);
            renderDiagrams(parsed);
            setStatus(`Analyzed ${file.name} | LB:${parsed.lbVservers.length} SVC:${parsed.services.length} SG:${parsed.serviceGroups.length} Binds:${parsed.binds.length}`);
        } catch (err) {
            console.error(err);
            setStatus(`Error: ${err.message || err}`);
        }
    });

    function setStatus(msg) {
        const el = document.getElementById('status');
        if (el) el.textContent = msg;
    }

    function parseNsConf(text) {
        const lbVservers = [];
        const services = [];
        const binds = [];
        const vpnVservers = [];
        const certKeys = [];
        const dnsServers = [];
        const ldapActions = [];
        const servers = [];
        const serviceGroups = [];

        const lines = text.split(/\r?\n/);
        for (const lineRaw of lines) {
            const line = lineRaw.trim();
            if (!line || line.startsWith('#')) continue;

            let m;
            if ((m = line.match(/add\s+lb\s+vserver\s+(\S+)\s+(\S+)\s+([\d\.]+)\s+(\d+)/i))) {
                lbVservers.push({ name: m[1], proto: m[2], ip: m[3], port: m[4] });
                continue;
            }
            if ((m = line.match(/add\s+service\s+(\S+)\s+(\S+)\s+([\d\.]+)\s+(\d+)/i))) {
                services.push({ name: m[1], proto: m[2], ip: m[3], port: m[4] });
                continue;
            }
            if ((m = line.match(/add\s+serviceGroup\s+("?)(.+?)\1\s+(\S+)/i))) {
                serviceGroups.push({ name: m[2], proto: m[3], members: [] });
                continue;
            }
            if ((m = line.match(/add\s+server\s+(\S+)\s+([\d\.]+)/i))) {
                servers.push({ name: m[1], ip: m[2] });
                continue;
            }
            if ((m = line.match(/bind\s+lb\s+vserver\s+(\S+)\s+("?)(.+?)\2/i))) {
                binds.push({ lb: m[1], svc: m[3] });
                continue;
            }
            if ((m = line.match(/bind\s+serviceGroup\s+("?)(.+?)\1\s+(\S+)\s+(\d+)/i))) {
                const sgName = m[2];
                const memberName = m[3];
                const memberPort = m[4];
                const sg = serviceGroups.find(s => s.name === sgName);
                if (sg) {
                    const serverObj = servers.find(s => s.name === memberName);
                    sg.members.push({ name: memberName, ip: serverObj?.ip || '', port: memberPort });
                }
                continue;
            }
            if ((m = line.match(/add\s+vpn\s+vserver\s+(\S+)\s+(\S+)\s+([\d\.]+)\s+(\d+)/i))) {
                vpnVservers.push({ name: m[1], proto: m[2], ip: m[3], port: m[4] });
                continue;
            }
            if ((m = line.match(/add\s+ssl\s+certKey\s+(\S+)/i))) {
                certKeys.push({ name: m[1] });
                continue;
            }
            if ((m = line.match(/add\s+dns\s+nameserver\s+([\d\.]+)/i))) {
                dnsServers.push(m[1]);
                continue;
            }
            if ((m = line.match(/add\s+authentication\s+ldapAction\s+(\S+)/i))) {
                ldapActions.push({ name: m[1] });
                continue;
            }
        }

        return { lbVservers, services, binds, vpnVservers, certKeys, dnsServers, ldapActions, servers, serviceGroups };
    }

    function extractFileFromTar(bytes, targetName) {
        const dec = new TextDecoder();
        const block = 512;
        let offset = 0;
        while (offset + block <= bytes.length) {
            const header = bytes.slice(offset, offset + block);
            const name = dec.decode(header.slice(0, 100)).replace(/\0.*$/, '');
            if (!name) break;
            const sizeOct = dec.decode(header.slice(124, 136)).replace(/\0.*$/, '').trim();
            const size = parseInt(sizeOct, 8) || 0;
            const dataStart = offset + block;
            const dataEnd = dataStart + size;
            if (name.toLowerCase().endsWith(targetName.toLowerCase()) || name === targetName) {
                return bytes.slice(dataStart, dataEnd);
            }
            const padded = Math.ceil(size / block) * block;
            offset = dataStart + padded;
        }
        return null;
    }

    function renderSummary(data) {
        const set = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
        };
        set('lbCount', data.lbVservers.length);
        set('svcCount', data.services.length + data.serviceGroups.length);
        set('vpnCount', data.vpnVservers.length);
        set('certCount', data.certKeys.length);
        set('dnsCount', data.dnsServers.length);
        set('ldapCount', data.ldapActions.length);
    }

    function renderDetails(data) {
        renderList('lbList', data.lbVservers.map(v => `${v.name} (${v.proto}) ${v.ip}:${v.port}`));
        const svcItems = [
            ...data.services.map(s => `${s.name} (${s.proto}) ${s.ip}:${s.port}`),
            ...data.serviceGroups.map(g => `SG: ${g.name} (${g.proto}) members:${g.members.length}`)
        ];
        renderList('svcList', svcItems);
        renderList('bindList', data.binds.map(b => `${b.lb} ➜ ${b.svc}`));
        renderList('vpnList', data.vpnVservers.map(v => `${v.name} (${v.proto}) ${v.ip}:${v.port}`));
        renderList('certList', data.certKeys.map(c => c.name));
        renderList('dnsList', data.dnsServers);
        renderList('ldapList', data.ldapActions.map(a => a.name));
        renderList('serverList', data.servers.map(s => `${s.name} (${s.ip})`));
    }

    function renderList(id, items) {
        const el = document.getElementById(id);
        if (!el) return;
        if (!items || !items.length) { el.innerHTML = '<div style="color:#94a3b8;">None</div>'; return; }
        el.innerHTML = items.map(t => `<div style="padding:6px 8px; border:1px solid #1f2937; border-radius:6px; margin-bottom:6px; background:#0b1224;">${escapeHtml(t)}</div>`).join('');
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function renderDiagrams(data) {
        setStatus('Rendering diagrams...');
        renderLbDiagram(data);
        renderVpnDiagram(data);
        renderSvcByBackendDiagram(data);
        setStatus('Analyzed and rendered diagrams.');
    }

    function renderLbDiagram(data) {
        const lines = ['flowchart TD'];
        const nodeSet = new Set();
        const addNode = (id, label) => {
            if (nodeSet.has(id)) return;
            nodeSet.add(id);
            lines.push(`${id}["${label.replace(/"/g, '\\"')}"]`);
        };

        data.lbVservers.forEach(lb => {
            const id = cleanId(`lb_${lb.name}`);
            addNode(id, `LB: ${lb.name}\\n${lb.ip}:${lb.port}\\n${lb.proto}`);
        });

        data.services.forEach(svc => {
            const id = cleanId(`svc_${svc.name}`);
            addNode(id, `SVC: ${svc.name}\\n${svc.ip}:${svc.port}\\n${svc.proto}`);
        });
        data.serviceGroups.forEach(g => {
            const id = cleanId(`sg_${g.name}`);
            addNode(id, `SG: ${g.name}\\n${g.proto}`);
            g.members.forEach(m => {
                const beId = cleanId(`be_${m.ip || m.name}`);
                const label = m.ip ? `Backend: ${m.name}\\n${m.ip}:${m.port}` : `Backend: ${m.name}\\n:${m.port}`;
                addNode(beId, label);
                lines.push(`${id} --> ${beId}`);
            });
        });

        data.binds.forEach(b => {
            const lbId = cleanId(`lb_${b.lb}`);
            const targetSvc = data.services.find(s => s.name === b.svc);
            const targetSg = data.serviceGroups.find(sg => sg.name === b.svc);
            if (targetSvc) {
                const svcId = cleanId(`svc_${b.svc}`);
                lines.push(`${lbId} --> ${svcId}`);
            } else if (targetSg) {
                const sgId = cleanId(`sg_${b.svc}`);
                lines.push(`${lbId} --> ${sgId}`);
            }
        });

        renderMermaid('mermaidGraphLB', 'nsDiagramLB', lines);
    }

    function renderVpnDiagram(data) {
        const lines = ['flowchart TD'];
        const nodeSet = new Set();
        data.vpnVservers.forEach(v => {
            const id = cleanId(`vpn_${v.name}`);
            if (!nodeSet.has(id)) {
                nodeSet.add(id);
                lines.push(`${id}["VPN: ${v.name}\\n${v.ip}:${v.port}\\n${v.proto}"]`);
            }
        });
        renderMermaid('mermaidGraphVPN', 'nsDiagramVPN', lines);
    }

    function renderSvcByBackendDiagram(data) {
        const lines = ['flowchart TD'];
        const nodeSet = new Set();
        const addNode = (id, label) => {
            if (nodeSet.has(id)) return;
            nodeSet.add(id);
            lines.push(`${id}["${label.replace(/"/g, '\\"')}"]`);
        };
        // services keyed by backend IP: show svc -> backend
        data.services.forEach(svc => {
            const svcId = cleanId(`svc_${svc.name}`);
            addNode(svcId, `SVC: ${svc.name}\\n${svc.ip}:${svc.port}\\n${svc.proto}`);
            if (svc.ip) {
                const backendId = cleanId(`be_${svc.ip}`);
                addNode(backendId, `Backend: ${svc.ip}`);
                lines.push(`${svcId} --> ${backendId}`);
            }
        });
        data.serviceGroups.forEach(g => {
            const sgId = cleanId(`sg_${g.name}`);
            addNode(sgId, `SG: ${g.name}\\n${g.proto}`);
            g.members.forEach(m => {
                const backendId = cleanId(`be_${m.ip || m.name}`);
                const label = m.ip ? `Backend: ${m.name}\\n${m.ip}:${m.port}` : `Backend: ${m.name}\\n:${m.port}`;
                addNode(backendId, label);
                lines.push(`${sgId} --> ${backendId}`);
            });
        });
        renderMermaid('mermaidGraphSvc', 'nsDiagramSvc', lines);
    }

    function renderMermaid(targetId, diagId, lines) {
        const container = document.getElementById(targetId);
        if (!container) return;
        if (!lines || lines.length <= 1) {
            container.innerHTML = '<pre style="color:#94a3b8;">No data</pre>';
            return;
        }
        const mermaidText = lines.join('\n');
        container.innerHTML = '';
        try {
            mermaid.render(diagId, mermaidText, (svgCode) => {
                container.innerHTML = svgCode;
            });
        } catch (err) {
            container.innerHTML = '<pre style="color:#f87171;">Diagram render failed: ' + (err.message || err) + '</pre>';
        }
    }

    function cleanId(name) {
        return name.replace(/[^a-zA-Z0-9_]/g, '_');
    }
    </script>
</body>
</html>
