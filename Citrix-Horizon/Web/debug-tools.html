<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAB007 - Upload Debugs</title>
    <link rel="icon" type="image/png" href="images/lab007%20Icon.PNG">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { background:#0b1020; color:#e2e8f0; font-family:'Poppins',sans-serif; }
        .container { max-width:1200px; margin:30px auto; padding:0 16px; }
        .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:16px; margin-bottom:16px; }
        .btn { background:#22d3ee; border:none; color:#0b1020; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
        .btn-secondary { background:#e5b600; color:#000; border:1px solid #e5b600; }
        .tabs { display:flex; gap:12px; margin-bottom:12px; }
        .tab { padding:10px 14px; border-radius:8px; background:rgba(255,255,255,0.06); cursor:pointer; color:#cbd5e1; border:1px solid transparent; }
        .tab.active { background:#11182a; border-color:rgba(255,255,255,0.12); color:#fff; }
        .panel { display:none; }
        .panel.active { display:block; }
        .input { width:100%; padding:10px; border-radius:8px; border:1px solid #1f2937; background:#0b1020; color:#e2e8f0; }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="margin:0 0 6px 0;">Upload Debug Logs</h2>
        <p style="color:#94a3b8; margin-top:0;">Store raw logs or anonymize sensitive data before download.</p>

        <div class="tabs">
            <div class="tab active" id="tabStore" onclick="showDebugTab('store')">Upload &amp; Store</div>
            <div class="tab" id="tabAnon" onclick="showDebugTab('anon')">Anonymise Log</div>
        </div>

        <div id="panelStore" class="panel active card">
            <h3 style="margin-top:0;">Upload &amp; Store</h3>
            <input type="file" id="debugStoreFile" class="btn btn-secondary" style="padding:10px; min-height:44px;">
            <div id="debugStoreStatus" style="margin-top:10px; color:#94a3b8;"></div>
        </div>

        <div id="panelAnon" class="panel card">
            <h3 style="margin-top:0;">Anonymise Log</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-bottom:12px;">
                    <div>
                        <label style="display:block; margin-bottom:4px;">Domain Names</label>
                        <input id="anonDomains" class="input" placeholder="example.com, corp.local">
                        <small style="color:#94a3b8;">Matches replaced with DUMMYDOMAIN. Comma separated.</small>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:4px;">Server name prefix</label>
                        <input id="anonServerPrefix" class="input" placeholder="e.g. HZN-">
                        <small style="color:#94a3b8;">Matches like prefix* become SERVERNAME</small>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <label><input type="checkbox" id="anonIp" checked> Replace IP addresses with 1.2.3.4</label>
                        <label><input type="checkbox" id="anonUser" checked> Replace usernames with USERID</label>
                        <label><input type="checkbox" id="anonOuHide"> Replace OU=...; with OU=HIDDEN;</label>
                    </div>
            </div>
            <input type="file" id="anonFile" class="btn btn-secondary" style="padding:10px; min-height:44px; margin-bottom:8px;">
            <div id="anonStatus" style="margin-top:6px; color:#94a3b8;"></div>
        </div>
    </div>

    <script>
    function showDebugTab(tab){
        ['store','anon'].forEach(t=>{
            document.getElementById('panel'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.toggle('active', t===tab);
            document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.toggle('active', t===tab);
        });
    }

    // Upload & store
    (function(){
        const fileInput = document.getElementById('debugStoreFile');
        const status = document.getElementById('debugStoreStatus');
        if (fileInput) {
            fileInput.addEventListener('change', async (e)=>{
                const file = e.target.files?.[0];
                if (!file) return;
                if (status) status.innerHTML = '<span class="spinner-eye"></span> Uploading...';
                const fd = new FormData();
                fd.append('debugFile', file);
                try{
                    const res = await fetch('/citrix/api/upload-debug',{ method:'POST', body:fd });
                    const data = await res.json().catch(()=> ({}));
                    if (!res.ok || !data.success) throw new Error(data.error || 'Upload failed');
                    if (status) status.textContent = `Stored ${data.file.originalname} (${data.file.size} bytes)`;
                }catch(err){
                    console.error(err);
                    if (status) status.textContent = 'Upload error: '+ (err.message||err);
                }finally{
                    e.target.value = '';
                }
            });
        }
    })();

    // Anonymise
    (function(){
        const fileInput = document.getElementById('anonFile');
        const status = document.getElementById('anonStatus');
        if (!fileInput) return;
        fileInput.addEventListener('change', async (e)=>{
            const file = e.target.files?.[0];
            if (!file) return;
            if (status) status.innerHTML = '<span class="spinner-eye"></span> Processing...';
            try{
                const text = await file.text();
                const domainsRaw = document.getElementById('anonDomains')?.value || '';
                const domainList = domainsRaw.split(',').map(s=>s.trim()).filter(Boolean);
                const doIp = document.getElementById('anonIp')?.checked;
                const doUser = document.getElementById('anonUser')?.checked;
                const serverPrefix = (document.getElementById('anonServerPrefix')?.value || '').trim();
                const doOuHide = document.getElementById('anonOuHide')?.checked;
                let out = text;
                // domains
                domainList.forEach(d=>{
                    const esc = d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
                    const re = new RegExp(esc,'gi');
                    out = out.replace(re,'DUMMYDOMAIN');
                });
                // IPs
                if (doIp) {
                    out = out.replace(/\b(?:\d{1,3}\.){3}\d{1,3}\b/g,'1.2.3.4');
                }
                // usernames
                if (doUser) {
                    out = out.replace(/\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g,'USERID');
                    out = out.replace(/\b[a-zA-Z]{2,3}\d+\b/g,'USERID');
                }
                // server name prefix (partial)
                if (serverPrefix) {
                    const esc = serverPrefix.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
                    const re = new RegExp(`${esc}[A-Za-z0-9._-]*`, 'gi');
                    out = out.replace(re,'SERVERNAME');
                }
                // OU structure hide
                if (doOuHide) {
                    out = out.replace(/OU=[^;]*;/g,'OU=HIDDEN;');
                }
                const extMatch = file.name.match(/(\.[^.]+)$/);
                const ext = extMatch ? extMatch[1] : '.txt';
                const base = file.name.replace(/(\.[^.]+)$/,'');
                const fname = `${base}_anon${ext}`;
                const blob = new Blob([out], {type:'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = fname;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                if (status) status.textContent = `Anonymised and downloaded: ${fname}`;
            }catch(err){
                console.error(err);
                if (status) status.textContent = 'Anonymise error: '+ (err.message||err);
            }finally{
                e.target.value = '';
            }
        });
    })();
    </script>
</body>
</html>
